<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA (Paso 1/‚Ä¶): metadatos y manifest -->
    <meta name="theme-color" content="#8a2be2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MiDespensa">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <title>MiDespensa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e6ccff, #8a2be2);
            min-height: 100vh;
            padding: 20px;
        }
        
        :root{
            --z-fab: 900;        /* bot√≥n engranaje */
            --z-fab-menu: 910;   /* men√∫ config desplegable */

            --z-overlay: 1000;   /* fondos oscuros */
            --z-popup: 1010;     /* popups blancos (cajas) */
            --z-modal: 1020;     /* modales confirmaci√≥n */
            --z-toast: 1030;     /* √©xitos / avisos que deben ir arriba del todo */
        }

        .pantalla {
            display: none;
            max-width: 900px;
            margin: 0 auto;
    
            min-height: 100vh;
            box-sizing: border-box;
    
            /* Unificamos el padding para evitar 3 reglas pis√°ndose */
            padding: 40px 16px;
        }

        .pantalla.activa {
            display: block;
        }

        .pantalla h1,
        .pantalla h2 {
            color: white;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
        }
       
        button {
            padding: 12px 25px;
            background-color: #8a2be2;
            color: white;
            border: 2px solid white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
            width: 80%;
            max-width: 400px;
            margin: 10px auto;
            display: block;
        }
        
        
        button:hover {
            background-color: #6a1db9;
        }

        
        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            background: #4b0082;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            color: white;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
        }
        
        li button {
    margin: 0 0 0 10px;     /* mismo efecto que margin-left */
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;

    /* CLAVE: que no herede el ‚Äúbot√≥n grande‚Äù */
    width: auto;
    max-width: none;
    display: inline-block;
}
       
       
li button:nth-of-type(1) { /* Bot√≥n Editar */
    background-color: #f39c12;
    color: white;
}

li button:nth-of-type(2) { /* Bot√≥n Eliminar */
    background-color: red;
    color: white;
}

li button:hover {
    opacity: 0.8;
}

/* Estilos existentes */

/* Otros estilos */

        input, textarea, select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: var(--z-overlay);
            display: none;
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            z-index: var(--z-popup);
            display: none;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        /* ‚úÖ Popup: permitir scroll cuando el contenido es largo (iPhone) */
        .popup {
          max-height: 80vh;
          overflow-y: auto;
        }

        /* ‚úÖ Lista de ingredientes dentro del popup */
        #popupDescripcion {
          max-height: 55vh;
          overflow-y: auto;
        }

        .popup h2 {
            margin-bottom: 20px;
            font-size: 20px;
            text-align: center;
        }

        .popup button {
            margin: 10px;
            width: 100px;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        .popup .botones {
            display: flex;
            justify-content: space-between;
        }

        .popup button:nth-of-type(1) {
            background-color: #28a745;
            color: white;
        }

        .popup button:nth-of-type(2) {
            background-color: #8a2be2;
            color: white;
        }

        .popup button:nth-of-type(3) {
            background-color: red;
            color: white;
        }

        .popup button:nth-of-type(4) {
            background-color: #6a1db9;
            color: white;
        }

        .popup button:hover {
            opacity: 0.8;
        }
        
       /* Estilo para la tabla de Crear Men√∫ */
#tablaMenu {
    width: 100%;
    margin-top: 20px;
    border-collapse: collapse;
    background-color: #fff;
    border-radius: 5px;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
}

#tablaMenu th, #tablaMenu td {
    padding: 10px;
    text-align: center;
    border: 1px solid #ddd;
}

#tablaMenu th {
    background-color: #8a2be2;
    color: white;
}

#tablaMenu input {
    width: 80%;
    padding: 5px;
    border-radius: 5px;
    border: 1px solid #ccc;
}

#tablaMenu td:first-child {
    font-weight: bold; /* Negrita */
    color: white; /* Texto blanco */
    background-color: #8a2be2; /* Morado oscuro */
}


#modalEditarProducto {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
}

/* ===== BASE √öNICA PARA MODALES (NO DUPLICAR) ===== */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: var(--z-modal);
    justify-content: center;
    align-items: center;
}

/* Soporto tus 2 nombres: modal-content y modal-contenido */
.modal-content,
.modal-contenido {
    background: #fff;
    color: #000;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

/* T√≠tulos dentro de modales: visibles en todos los temas y m√°s peque√±os */
.modal .modal-contenido h1,
.modal .modal-contenido h2,
.modal .modal-contenido h3 {
    color: #111;
    font-size: 20px;
    margin: 0 0 14px;
    line-height: 1.2;
}

.modal-botones,
.modal-buttons {
    margin-top: 15px;
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
}

#modalConfirmacionReceta {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: var(--z-modal);
}


.modal button:hover {
    background: #218838;
}



#modalExitoProducto {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 20px;
    background-color: #4caf50;
    color: white;
    border-radius: 10px;
    font-size: 18px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    text-align: center;
    z-index: var(--z-toast);
}



#tablaEdicion {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

#tablaEdicion th, #tablaEdicion td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: center;
}

.botones-menu-semanal {
  display: flex;
  justify-content: center;
  gap: 10px; /* Espacio entre botones */
  margin-top: 10px;
}

.botones-menu-semanal button {
    padding: 5px 10px;
    font-size: 14px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    
    width: auto;
    max-width: none;
    display: inline-block;
    margin: 0;
}

#btnEditar {
  background-color: #FFA500; /* Amarillo anaranjado */
  color: white;
}

#btnArchivar {
  background-color: #0056b3; /* Azul oscuro */
  color: white;
}



.modal-botones {
  margin-top: 15px;
}

#tablaEdicion {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

#tablaEdicion th,
#tablaEdicion td {
  padding: 8px;
  border: 1px solid #ddd;
  text-align: center;
}

.overlayPasos {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: var(--z-overlay);
}

.popupPasos {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    display: none;
    width: 80%;
    max-width: 400px;
    z-index: var(--z-popup);
}

.popupPasos textarea {
    width: 100%;
    height: 150px;
    margin-bottom: 10px;
    padding: 10px;
}

.botones button {
    margin: 5px;
}

/* Bot√≥n Agregar Paso - Azul claro */
#popupPasos .botones button:nth-child(1) {
    background-color: #4da6ff; /* Azul claro */
    color: white;
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 5px;
}

#popupPasos .botones button:nth-child(1):hover {
    background-color: #3399ff; /* Azul m√°s intenso al pasar el cursor */
}

/* Bot√≥n Guardar Cambios - Verde */
#popupPasos .botones button:nth-child(2) {
    background-color: #4CAF50; /* Verde */
    color: white;
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 5px;
}

#popupPasos .botones button:nth-child(2):hover {
    background-color: #45a049; /* Verde m√°s oscuro al pasar el cursor */
}

/* Bot√≥n Cerrar - Morado */
#popupPasos .botones button:nth-child(3) {
    background-color: #8A2BE2; /* Morado */
    color: white;
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 5px;
}

#popupPasos .botones button:nth-child(3):hover {
    background-color: #7a1cd8; /* Morado m√°s oscuro al pasar el cursor */
}

#listaPasosGuardados .btnEditar {
    background-color: #FFA500; /* Amarillo anaranjado */
    color: white;
    border: none;
    padding: 5px 8px;
    margin-left: 5px;
    cursor: pointer;
    border-radius: 3px;
    font-size: 12px;
}

#listaPasosGuardados .btnEditar:hover {
    background-color: #FF8C00; /* Naranja m√°s oscuro */
}

#listaPasosGuardados .btnEliminar {
    background-color: #E53935; /* Rojo */
    color: white;
    border: none;
    padding: 5px 8px;
    margin-left: 5px;
    cursor: pointer;
    border-radius: 3px;
    font-size: 12px;
}

#listaPasosGuardados .btnEliminar:hover {
    background-color: #C62828; /* Rojo m√°s oscuro */
}

#btnVaciarCarrito {
    background-color: #d9534f; /* Rojo suave */
    color: white;
    border: none;
    padding: 10px 15px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 5px;
    margin: 10px auto; /* Centra horizontalmente */
    display: block;
    text-align: center;
}

#btnVaciarCarrito:hover {
    background-color: #c9302c; /* Rojo m√°s oscuro en hover */
}

/* Estilos del modal de confirmaci√≥n */


.modal h2 {
    margin: 0;
    font-size: 24px;
    color: #333;
}

.modal p {
    margin: 10px 0;
    font-size: 16px;
    color: #555;
}

.modal-buttons button {
    background-color: #f44336; /* Rojo para el bot√≥n 'S√≠' */
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    margin: 10px;
    transition: background-color 0.3s;
        width: auto;
    max-width: none;
    display: inline-block;
}

.modal-buttons button:hover {
    background-color: #d32f2f; /* Rojo m√°s oscuro cuando se pasa el mouse */
}

.modal-buttons button:nth-child(2) {
    background-color: #9C27B0; /* Morado para el bot√≥n 'Cancelar' */
}

.modal-buttons button:nth-child(2):hover {
    background-color: #7B1FA2; /* Morado m√°s oscuro cuando se pasa el mouse */
}


/* Estilos espec√≠ficos para el modal de √©xito */
#modalCarritoVaciado .modal-content {
    background-color: #ffffff; /* Fondo blanco */
    color: #333; /* Texto oscuro */
    padding: 8px 12px; /* Espaciado m√°s reducido */
    border-radius: 8px;
    max-width: 250px; /* Suficiente ancho para evitar desbordamiento */
    width: fit-content; /* Se ajusta autom√°ticamente al contenido */
    text-align: center;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    font-size: 12px; /* Tama√±o de letra m√°s peque√±o */
    white-space: normal; /* Permite que el texto haga salto de l√≠nea si es necesario */
    word-wrap: break-word; /* Asegura que el texto no se salga del modal */
}

/* Reducir el tama√±o del t√≠tulo dentro del modal */
#modalCarritoVaciado h2 {
    font-size: 14px; /* Tama√±o de fuente m√°s peque√±o */
    margin: 0; /* Evita espacios adicionales */
    padding: 5px; /* Reduce el espaciado interno */
    line-height: 1.2; /* Reduce la separaci√≥n entre l√≠neas */
}

/* Estilos del modal de confirmaci√≥n */
#modalConfirmacion {
    display: none; /* Modal oculto por defecto */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Fondo oscuro con opacidad */
    justify-content: center;
    align-items: center;
    z-index: var(--z-modal);
}

/* Contenido dentro del modal */
#modalConfirmacion .modal-content {
    display: flex;
    flex-direction: column;
    align-items: center; /* Centra todo el contenido */
    text-align: center;
    background-color: white;
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    width: 90%;
}

/* Estilos del contenedor de los botones */
#modalConfirmacion .modal-buttons {
    display: flex;
    justify-content: center; /* Centra los botones horizontalmente */
    gap: 15px; /* Espaciado entre botones */
    width: 100%; /* Asegura que ocupe todo el ancho disponible */
    margin-top: 20px; /* Separaci√≥n entre el mensaje y los botones */
}

/* Estilos de los botones */
#modalConfirmacion .modal-buttons button {
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 5px;
    border: none;
    transition: background-color 0.3s;
}

/* Bot√≥n de "S√≠" (Vaciar Carrito) */
#modalConfirmacion .modal-buttons button:first-child {
    background-color: #f44336; /* Rojo */
    color: white;
}

/* Bot√≥n de "Cancelar" */
#modalConfirmacion .modal-buttons button:nth-child(2) {
    background-color: #9C27B0; /* Morado */
    color: white;
}

/* Cambio de color en hover */
#modalConfirmacion .modal-buttons button:hover {
    opacity: 0.8; /* Efecto de opacidad al pasar el rat√≥n */
}

#listaAlertas li {
        color: #ff4d4d; /* Rojo m√°s claro */
        font-weight: bold;
}



#paginacionCarrito button {
    font-size: 12px; /* Tama√±o m√°s peque√±o */
    padding: 5px 10px; /* Tama√±o de los botones */
    background-color: #6a1b9a; /* Color morado */
    color: white; /* Color del texto */
    border: none; /* Sin borde */
    border-radius: 5px; /* Bordes redondeados */
    cursor: pointer; /* Cursor en forma de mano */
    transition: background-color 0.3s; /* Transici√≥n suave para el color */
}

#paginacionCarrito button:hover {
    background-color: #8e24aa; /* Morado m√°s claro al pasar el rat√≥n */
}

#paginacionCarrito button:disabled {
    background-color: #ddd; /* Color cuando el bot√≥n est√° deshabilitado */
    cursor: not-allowed;
}

/* Reducir tama√±o del bot√≥n Cambiar Tema */
.btn-tema {
    font-size: 14px;
    padding: 6px 12px;
    margin-top: 5px;
}



.modal button {
    display: block;
    width: 100%;
    margin: 10px 0;
    padding: 10px 20px;
    border: none;
    cursor: pointer;
    border-radius: 5px;
}


/* Bot√≥n de Configuraci√≥n */
#configuracion {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #444;
    color: white;
    padding: 10px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 20px;
    text-align: center;
    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
}

/* Men√∫ de Configuraci√≥n (Oculto por defecto) */
.menu-config {
    display: none;
    position: fixed;
    bottom: 60px;
    right: 20px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
    padding: 10px;
}

.menu-config button {
    background: none;
    border: none;
    padding: 10px;
    cursor: pointer;
    font-size: 16px;
    width: 100%;
    text-align: left;
    color: black;
}

.menu-config button:hover {
    background: #f0f0f0;
}

/* Para las tablas en general */
.tablaMenu {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
}

/* Encabezado de las tablas */
.celdaEncabezado {
    background-color: #8a2be2;
    color: white;
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
    font-weight: bold;
}

/* Celdas de los men√∫s */
.celdaMenu {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
    font-weight: bold;
    font-family: 'Poppins', sans-serif;
}

/* T√≠tulos de los men√∫s */
.tituloMenu {
    font-size: 1.2em;
    text-align: center;
    margin-bottom: 5px;
    font-family: "Poppins", sans-serif;
}

/* Mensaje cuando no hay men√∫s archivados */
.mensajeVacio {
    text-align: center;
    font-size: 1.2em;
}

/* ====== TEMAS ====== */

/* Tema Claro */
.tema-claro {
    background: #ffffff;
    color: #000000;
}

.tema-claro .celdaMenu,
.tema-claro .tituloMenu,
.tema-claro .mensajeVacio {
    color: #000000;
}

.tema-claro .celdaEncabezado {
    background-color: #8a2be2;
    color: #ffffff;
}

/* Tema Oscuro */
.tema-oscuro {
    background: #1e1e1e;
    color: #ffffff;
}

.tema-oscuro .celdaMenu,
.tema-oscuro .tituloMenu,
.tema-oscuro .mensajeVacio {
    color: #ffffff;
}

.tema-oscuro .celdaEncabezado {
    background-color: #8a2be2;
    color: #ffffff;
}

/* Tema Original */
.tema-original {
    background: linear-gradient(135deg, #b08bd6, #8a5dc4);
    color: #ffffff;
}

.tema-original .celdaMenu,
.tema-original .tituloMenu,
.tema-original .mensajeVacio {
    color: #ffffff;
}

.tema-original .celdaEncabezado {
    background-color: #8a2be2;
    color: #ffffff;
}

.tema-claro h1, .tema-claro h2, .tema-claro h3 { color: #000; }
.tema-oscuro h1, .tema-oscuro h2, .tema-oscuro h3 { color: #fff; }
.tema-original h1, .tema-original h2, .tema-original h3 { color: #fff; }

.modal-botones {
  margin-top: 15px;
  display: flex;
  justify-content: space-around;
}

.btn-verde {
  background-color: green;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.btn-verde:hover {
  background-color: darkgreen;
}

.modal-confirmacion {
  display: none;
  position: fixed;
  z-index: var(--z-modal);
  left: 0; top: 0;
  width: 100%; height: 100%;
  background-color: rgba(0, 0, 0, 0.3);
  justify-content: center;
  align-items: center;
}

.modal-contenido-confirmacion {
  background-color: #fff;
  color: #000; /* Texto negro */
  padding: 20px 30px;
  border-radius: 12px;
  text-align: center;
  max-width: 300px;
  font-weight: bold;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  animation: fadeIn 0.25s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.paso-seleccionado {
    outline: 2px solid rgba(0, 0, 0, 0.15);
    border-radius: 8px;
}



.pantalla h1, .pantalla h2, .pantalla h3 {
  text-align: center;
  margin-top: 8px;
  margin-bottom: 16px;
}

/* contenedores de botones (si usas divs tipo "botones", "menu", etc.) */
.pantalla .botones, 
.pantalla .contenedor-botones,
.pantalla .menu {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

/* botones centrados */
.pantalla button {
    align-self: center;
    margin-bottom: 18px;
}

#modalMenuEliminadoExito { z-index: var(--z-toast) !important; }

#configuracion { z-index: var(--z-fab); }
.menu-config { z-index: var(--z-fab-menu); }

#modalConfirmacionReset { z-index: var(--z-toast) !important; }



/* Bot√≥n Volver ‚Äì m√°s discreto */
.btn-volver {
    width: 65%;          /* un poco m√°s estrecho */
    max-width: 320px;
    padding: 9px 18px;   /* menos alto */
    font-size: 14px;     /* texto ligeramente m√°s peque√±o */
    opacity: 0.9;
}

/* Hover m√°s sutil */
.btn-volver:hover {
    opacity: 1;
}

/* Carrito: forzar botones Editar/Eliminar en una sola l√≠nea */
#listaCarrito .acciones-carrito{
  display: none;              /* oculto hasta que pulses el item */
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
  flex-wrap: nowrap;          /* NO permite salto de l√≠nea */
}

#listaCarrito .acciones-carrito button{
  width: auto;                /* anula el width:80% global */
  max-width: none;
  margin: 0;                  /* anula m√°rgenes globales */
  display: inline-block;
  padding: 8px 14px;          /* tama√±o m√°s razonable en botones peque√±os */
  font-size: 14px;
}

/* Blindaje: texto visible dentro de cualquier modal, incluso con tema oscuro */
.modal-content,
.modal-contenido,
.modal-contenido-confirmacion {
    color: #000 !important;
}

/* ‚úÖ Blindaje tambi√©n para t√≠tulos dentro de .modal-content (evita que el tema los ponga en blanco) */
.modal .modal-content h1,
.modal .modal-content h2,
.modal .modal-content h3,
.modal .modal-content p {
    color: #111 !important;
}

/* ===== PWA: banner de actualizaci√≥n ===== */
#updateBanner{
  position: fixed;
  left: 12px;
  right: 12px;
  bottom: 12px;
  z-index: 999999;            /* por encima de todo */
  background: rgba(0,0,0,0.88);
  color: #fff;
  padding: 12px 12px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  font-size: 14px;
}

#updateBanner button{
  width: auto;
  margin: 0;
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 10px;
}

#updateBanner { display: none; }
#updateBanner.is-visible { display: flex; }

#listaDespensa .acciones-despensa{
  display: none;
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
  flex-wrap: nowrap;
}
#listaDespensa .acciones-despensa button{
  width: auto;
  max-width: none;
  margin: 0;
  display: inline-block;
  padding: 8px 14px;
  font-size: 14px;
}

#listaDespensa li.seleccionado {
    outline: 2px solid rgba(173, 216, 230, 0.9);
    background-color: rgba(173, 216, 230, 0.25);
}

/* Ajuste visual del t√≠tulo en el modal de confirmaci√≥n de Despensa */
#modalConfirmacionSeleccionadosDespensa h2 {
  font-size: 16px;      /* m√°s peque√±o */
  font-weight: 400;    /* normal (no negrita) */
  margin-bottom: 16px; /* un poco de aire */
  text-align: center;
}

    </style>
</head>
<body>
    <!-- Pantalla Principal -->
    <div id="pantalla1" class="pantalla activa">
        <button onclick="mostrarPantalla('pantalla6')">Planificador Semanal</button>
        <button onclick="mostrarPantalla('pantalla4')">Carro Compra</button>
        <button onclick="mostrarPantalla('pantalla8')">Inventario Nevera</button>
        <button onclick="mostrarPantalla('pantallaDespensa')">Despensa</button>
        <button onclick="mostrarPantalla('pantalla3')">Mis Recetas</button>
        <button onclick="mostrarPantalla('pantalla5')">A√±adir Receta</button>
        <button onclick="mostrarPantalla('pantalla10')">Paso a Paso</button> <!-- Nuevo bot√≥n -->
</div>


    <!-- Pantalla Planificador Semanal -->
    <div id="pantalla6" class="pantalla">
        <button onclick="mostrarPantalla('pantallaMenuSemanal')">Men√∫ Semanal</button>
        <button onclick="mostrarPantalla('pantallaCrearMenu')">Crear Men√∫</button>
        <button onclick="mostrarPantalla('pantallaMenusArchivados')">Men√∫s Archivados</button>
        <button class="btn-volver" onclick="mostrarPantalla('pantalla1')">Volver</button>
    </div>

  <!-- Pantalla Men√∫ Semanal -->
  <div id="pantallaMenuSemanal" class="pantalla">
  <h1>Men√∫ Semanal</h1>
  <!-- Contenedor para la tabla del men√∫ semanal -->
      <div id="contenedorMenuSemanal"></div>
  
  <!-- Botones Editar y Archivar en una sola l√≠nea -->
  <div id="botonesMenuSemanal" class="botones-menu-semanal" style="display: none;">
    <button id="btnEditar" onclick="abrirModalEditar()">Editar</button>
    <button id="btnArchivar" onclick="abrirModalConfirmarArchivarMenu()">Archivar</button>
  </div>
  
  <button class="btn-volver" onclick="mostrarPantalla('pantalla6')">Volver</button>
  </div>


    
    <!-- Pantalla Crear Men√∫ -->
    <div id="pantallaCrearMenu" class="pantalla">
  
    <table id="tablaMenu">
        <thead>
            <tr>
                <th>D√≠a</th>
                <th>Comida</th>
                <th>Cena</th>
            </tr>
        </thead>
        <tbody>
            <!-- Las filas de los d√≠as de la semana se llenar√°n mediante JavaScript -->
        </tbody>
    </table>
    <button onclick="guardarMenu()">Guardar Men√∫</button>
    <button class="btn-volver" onclick="mostrarPantalla('pantalla6')">Volver</button>
    </div>


    <!-- Pantalla Men√∫s Archivados -->
    <div id="pantallaMenusArchivados" class="pantalla">
      <h1>Men√∫s Archivados</h1>
    
      <!-- Aqu√≠ se pintar√° la tabla de archivados -->
      <div id="contenedorMenuGuardado"></div>
    
      <button class="btn-volver" onclick="mostrarPantalla('pantalla6')">Volver</button>
    </div>
   
    <!-- Pantalla Mis Recetas -->
    <div id="pantalla3" class="pantalla">
        <button onclick="mostrarRecetas('Comida')">Comida</button>
        <button onclick="mostrarRecetas('Cena')">Cena</button>
        <button onclick="mostrarRecetas('Otros')">Otros</button>
        <button class="btn-volver" onclick="mostrarPantalla('pantalla1')">Volver</button>
    </div>

    <!-- Pantalla Recetas -->
    <div id="pantallaRecetas" class="pantalla">
        <h1 id="tituloRecetas"></h1>
        <ul id="listaRecetas"></ul>
        <button class="btn-volver" onclick="mostrarPantalla('pantalla3')">Volver</button>
    </div>

    <!-- Pantalla A√±adir Receta -->
     <div id="pantalla5" class="pantalla">
        <input type="text" id="nombreReceta" placeholder="Nombre de la receta" required>
        <table id="tablaIngredientes">
          <thead>
             <tr>
                <th></th>
                <th></th>
                <th></th>
             </tr>
          </thead>
        <tbody id="cuerpoTablaIngredientes"></tbody>
        <table>
    <!--Tab to edit-->
         </table></table>
         <button onclick="agregarFilaIngrediente()">A√±adir Ingrediente</button>
        <select id="tipoComida">
            <option value="Comida">Comida</option>
            <option value="Cena">Cena</option>
            <option value="Otros">Otros</option>
        </select>
        <button onclick="guardarReceta()">Guardar</button>
        <button class="btn-volver" onclick="mostrarPantalla('pantalla1')">Volver</button>
    </div>

    <!-- Pantalla Carro Compra -->
    <div id="pantalla4" class="pantalla">
    <!-- Botones a√±adidos -->
    <button onclick="irAlCarrito()">Ir al Carrito</button>
    <button onclick="mostrarPantalla('pantallaA√±adirCarro')">A√±adir al Carro</button>
    <button class="btn-volver" onclick="mostrarPantalla('pantalla1')">Volver</button>
    </div>

    <!-- Pantalla Carrito -->
    <div id="pantallaCarrito" class="pantalla">
         <h1>Carrito</h1>
         <ul id="listaCarrito"></ul>
         <div id="paginacionCarrito" style="text-align: center; margin-top: 10px;"></div>
         <button id="btnVaciarCarrito" onclick="mostrarModalVaciarCarrito()" style="display: none;">Vaciar Carro üõí</button>
         <button id="btnEliminarSeleccionados" 
        onclick="abrirModalConfirmacionSeleccionados()" 
        style="display: none; background-color: red; color: white;">
    Eliminar Seleccionados
         </button>
         <button class="btn-volver" onclick="mostrarPantalla('pantalla4')">Volver</button>
    </div>


    <!-- Pantalla A√±adir al Carro -->
    <div id="pantallaA√±adirCarro" class="pantalla">
    <h1>A√±adir al Carro</h1>
    <input type="text" id="nombreIngrediente" placeholder="Nombre del ingrediente" required>
    <input type="number" id="cantidadIngrediente" placeholder="Cantidad (opcional)" min="0">
    <button onclick="anadirAlCarrito()">A√±adir Ingrediente</button>
    <button class="btn-volver" onclick="mostrarPantalla('pantalla4')">Volver</button>
    </div>



    <!-- Pantalla Inventario Nevera -->
    <div id="pantalla8" class="pantalla">
        <button onclick="verInventario()">Ver Inventario</button>
        <button id="btnA√±adirProducto" onclick="mostrarPantalla('pantalla9')">A√±adir Producto</button> <!-- bot√≥n "A√±adir Producto" -->
        <button onclick="verAlertas()">Alertas</button>
        <button class="btn-volver" onclick="mostrarPantalla('pantalla1')">Volver</button>
    </div>

    <!-- Pantalla Inventario (Ver Productos) -->
    <div id="pantallaInventario" class="pantalla">
        <h1>Inventario</h1>
        <ul id="listaInventario"></ul>
        <button class="btn-volver" onclick="mostrarPantalla('pantalla8')">Volver</button>
    </div>

    <!-- Pantalla A√±adir Producto -->
    <div id="pantalla9" class="pantalla">
        <h1>A√±adir Producto</h1>
        <input type="text" id="nombreProducto" placeholder="Nombre del producto" required>
        <input type="number" id="cantidadProducto" placeholder="Cantidad (en gramos)" min="1" required>
        <input type="date" id="fechaCaducidad" required>
        <button onclick="guardarProducto()">Guardar Producto</button>
        <button class="btn-volver" onclick="mostrarPantalla('pantalla8')">Volver</button>
    </div>
    
    <!-- Pantalla Alertas -->
    <div id="pantallaAlertas" class="pantalla">
    <h1>Productos Pr√≥ximos a Caducar</h1>
    <ul id="listaAlertas"></ul>
    <button class="btn-volver" onclick="mostrarPantalla('pantalla8')">Volver</button>
    </div>

    
    <!-- Pantalla Paso a Paso -->
    <div id="pantalla10" class="pantalla">
        <h1>Paso a Paso</h1>
        <ul id="listaPasoAPaso"></ul>
        <button class="btn-volver" onclick="mostrarPantalla('pantalla1')">Volver</button>
    </div>
    
    <!-- ========================= -->
    <!-- Pantalla Despensa (HUB)   -->
    <!-- ========================= -->
    <div id="pantallaDespensa" class="pantalla">
        <h1>Despensa</h1>
    
        <button onclick="abrirVerDespensa()">Ver Despensa</button>
        <button onclick="mostrarPantalla('pantallaDespensaAdd')">A√±adir a la Despensa</button>
    
        <button class="btn-volver" onclick="mostrarPantalla('pantalla1')">Volver</button>
    </div>

    <!-- ========================= -->
    <!-- Pantalla Ver Despensa     -->
    <!-- ========================= -->
    <div id="pantallaDespensaVer" class="pantalla">
        <h1>Despensa</h1>
    
        <ul id="listaDespensa"></ul>
        <button id="btnEliminarSeleccionadosDespensa" type="button" style="display:none;">
            Eliminar seleccionados
        </button>
        <div id="paginacionDespensa" style="text-align:center; margin-top:10px;"></div>
        <button class="btn-volver" onclick="mostrarPantalla('pantallaDespensa')">Volver</button>
    </div>

    <!-- ========================= -->
    <!-- Pantalla A√±adir a Despensa -->
    <!-- ========================= -->
    <div id="pantallaDespensaAdd" class="pantalla">
        <h1>A√±adir a la Despensa</h1>
    
        <input type="text" id="despensaNombre" placeholder="Nombre del producto" required>
        <input type="text" id="despensaCantidad" placeholder="Cantidad (opcional)">
        <input type="date" id="despensaCaducidad">
    
        <button onclick="guardarProductoDespensa()">Guardar</button>
        <button class="btn-volver" onclick="mostrarPantalla('pantallaDespensa')">Volver</button>
    </div>

    <!-- Overlay y Popup -->
    <div class="overlay" id="overlay" onclick="cerrarPopup()"></div>
    <div class="popup" id="popup">
        <p id="popupDescripcion"></p>
        <div class="botones">
            <button onclick="anadirAlCarritoDesdePopup()">Al Carro</button>
            <button onclick="verPasosReceta()">Ver Pasos</button>
            <button onclick="borrarReceta()">Borrar</button>
            <button class="btn-volver" onclick="cerrarPopup()">Volver</button>
        </div>
    </div>
    
    <div id="modalEditarProducto" style="display: none;">
    <div class="modal-content">
        <h3>Editar Producto</h3>
        <label for="editarNombre">Nombre del Producto:</label>
        <input type="text" id="editarNombre">
        <label for="editarCantidad">Cantidad (g):</label>
        <input type="number" id="editarCantidad">
        <label for="editarFechaCaducidad">Fecha de Caducidad:</label>
        <input type="date" id="editarFechaCaducidad">
        <button onclick="guardarEdicionProducto()">Guardar</button>
        <button onclick="cerrarModalEditarProducto()">Cancelar</button>
    </div>
  </div>
  
  
  <div id="modalConfirmacion" style="display: none;">
    <div class="modal-content">
        <h3>¬øEst√°s seguro de que deseas eliminar este producto?</h3>
        <button onclick="confirmarEliminacion()">S√≠</button>
        <button onclick="cerrarModalConfirmacion()">No</button>
    </div>
  </div>
  
  
  <!-- Modal de Confirmaci√≥n de Eliminaci√≥n -->
  <div id="modalEliminacionConfirmada" class="modal" style="display: none;">
    <div class="modal-contenido">
        <h3>¬°Receta eliminada!</h3>
    </div>
  </div>

  <div id="modalConfirmacionProducto" class="modal">
    <div class="modal-contenido">
        <p>¬øSeguro que quieres eliminar este <b>producto</b>?</p>
        
        <div class="modal-botones">
            <button id="btnConfirmarEliminarProducto">S√≠, eliminar</button>
            <button id="btnCancelarEliminarProducto">Cancelar</button>
        </div>
    </div>
</div> 
  
  
  <div id="modalConfirmacionReceta" class="modal">
    <div class="modal-contenido">
        <p>¬øSeguro que quieres eliminar esta <b>receta</b>?</p>
        <button onclick="confirmarEliminacionReceta()">S√≠, eliminar</button>
        <button onclick="cerrarModalConfirmacionReceta()">Cancelar</button>
    </div>
  </div>
  
  <div id="modalEliminacionProducto" class="modal">
    <div class="modal-contenido">
        <p>¬°Producto eliminado!</p>
    </div>
  </div>
  
  <div id="modalEliminacionReceta" class="modal">
    <div class="modal-contenido">
        <p>¬°Receta eliminada!</p>
    </div>
  </div>
  
  <!-- Modal para Producto a√±adido correctamente -->
<div id="modalProductoGuardado" class="modal">
    <div class="modal-content">
        <p>Producto a√±adido correctamente</p>
    </div>
</div>

<!-- Modal para Receta guardada correctamente -->
  <div id="modalRecetaGuardada" class="modal">
    <div class="modal-content">
        <p>Receta guardada correctamente</p>
    </div>
  </div>
  
<!-- Modal de √©xito para la actualizaci√≥n de productos -->
<div id="modalExitoProducto" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background-color: #4caf50; color: white; border-radius: 5px; text-align: center;">
    <p>Producto actualizado correctamente</p>
</div>

<div id="modalConfirmacionCarrito" class="modal">
    <div class="modal-contenido">
        <h2>¬øEliminar este producto?</h2>
        <button onclick="confirmarEliminacionCarrito()">S√≠, eliminar</button>
        <button onclick="cerrarModalConfirmacionCarrito()">Cancelar</button>
    </div>
</div>
  
  <div id="modalExitoPasos" class="modal">
    <div class="modal-contenido">
        ‚úÖ Cambios guardados
    </div>
  </div>

  <div id="modalEditarCarrito" class="modal">
    <div class="modal-contenido">
        <h2>Editar Producto</h2>
        <label for="editarNombreCarrito">Nombre:</label>
        <input type="text" id="editarNombreCarrito">
        <label for="editarCantidadCarrito">Cantidad (g):</label>
        <input type="text" id="editarCantidadCarrito">
        <button onclick="guardarEdicionCarrito()">Guardar</button>
        <button onclick="cerrarModalEdicion()">Cancelar</button>
    </div>
  </div>
  
  <div id="modalEditarDespensa" class="modal">
    <div class="modal-contenido">
        <h2>Editar producto (Despensa)</h2>
        <label>Nombre:</label>
        <input type="text" id="editarNombreDespensa">
        
        <label>Cantidad:</label>
        <input type="text" id="editarCantidadDespensa" placeholder="(opcional)">
        
        <label>Caducidad:</label>
        <input type="date" id="editarCaducidadDespensa">
        
        <button onclick="guardarEdicionDespensa()">Guardar</button>
        <button onclick="cerrarModalEditarDespensa()">Cancelar</button>
    </div>
</div>

<div id="modalConfirmacionDespensa" class="modal">
    <div class="modal-contenido">
        <h2>¬øEliminar este producto (Despensa)?</h2>
        <button onclick="confirmarEliminacionDespensa()">S√≠, eliminar</button>
        <button onclick="cerrarModalConfirmacionDespensa()">Cancelar</button>
    </div>
</div>
  
  
  
  <!-- Modal de confirmaci√≥n al a√±adir ingrediente al carrito -->
  <div id="modalIngredienteGuardado" class="modal">
    <div class="modal-contenido">
        <p>Ingrediente a√±adido correctamente.</p>
    </div>
  </div>

<!-- Modal de confirmaci√≥n al editar ingrediente del carrito -->
  <div id="modalEdicionCarrito" class="modal">
    <div class="modal-contenido">
        <p>Ingrediente editado correctamente.</p>
    </div>
  </div>
  
 
 <!-- Modal de edici√≥n del men√∫ (√öNICO, sin duplicados) -->
<div id="modalEditar" class="modal">
    <div class="modal-contenido">
        <h2>Editar Men√∫</h2>
        
        <table id="tablaEdicion">
            <thead>
                <tr>
                    <th>D√≠a</th>
                    <th>Comida</th>
                    <th>Cena</th>
                </tr>
            </thead>
            <tbody>
                <!-- Se llenar√° con JavaScript -->
            </tbody>
        </table>
        
        <div class="modal-botones">
            <button onclick="guardarEdicionMenu()" class="btn-verde">Guardar Cambios</button>
            <button onclick="cerrarModalEditar()">Cancelar</button>
        </div>
    </div>
</div>
  
  <!-- Modal: Editar Paso -->
<div id="modalEditarPaso" class="modal">
    <div class="modal-contenido">
        <h3>Editar paso</h3>
        <input type="text" id="inputEditarPaso" />
        <div class="modal-botones">
            <button id="btnGuardarPaso" class="btn-verde">Guardar</button>
            <button id="btnCancelarPaso">Cancelar</button>
        </div>
    </div>
</div>

<!-- Modal: Confirmar eliminar paso -->
<div id="modalConfirmarEliminarPaso" class="modal">
    <div class="modal-contenido">
        <p>¬øSeguro que quieres eliminar este paso?</p>
        <div class="modal-botones">
            <button id="btnSiEliminarPaso" style="background:red;color:white;border:none;padding:8px 12px;border-radius:6px;">
                S√≠, eliminar
            </button>
            <button id="btnNoEliminarPaso">Cancelar</button>
        </div>
    </div>
</div>

<div id="modalArchivadoExitoso" class="modal-confirmacion">
    <div class="modal-contenido-confirmacion">
        <p>Men√∫ archivado correctamente</p>
    </div>
</div>

<!-- Modal: Confirmar eliminar men√∫ archivado -->
<div id="modalConfirmacionEliminarMenu" class="modal">
    <div class="modal-contenido">
        <p id="textoConfirmacionEliminarMenu">¬øEliminar este men√∫?</p>
        <div class="modal-botones">
            <button id="btnConfirmarEliminarMenu" style="background:red;color:white;border:none;padding:10px 14px;border-radius:8px;">
                S√≠, eliminar
            </button>
            <button id="btnCancelarEliminarMenu">Cancelar</button>
        </div>
    </div>
</div>

<!-- Modal: Confirmar archivar men√∫ -->
<div id="modalConfirmacionArchivarMenu" class="modal">
    <div class="modal-contenido">
        <p>¬øSeguro que quieres archivar este men√∫?</p>
        <div class="modal-botones">
            <button id="btnConfirmarArchivarMenu" class="btn-verde">S√≠, archivar</button>
            <button id="btnCancelarArchivarMenu">Cancelar</button>
        </div>
    </div>
</div>


  
  <!-- Overlay y Popup de Pasos -->
  <div class="overlay" id="overlayPasos" onclick="cerrarPopupPasos()"></div>
  <div class="popup" id="popupPasos">
    <!-- Lista de pasos guardados -->
    <ul id="listaPasosGuardados"></ul>

    <!-- Campo para agregar un nuevo paso -->
    <textarea id="textareaPasos" rows="3" placeholder="Escribe un nuevo paso..."></textarea>

    <div class="botones">
        <button onclick="agregarPaso()">Agregar Paso</button>
        <button onclick="guardarCambiosPasos()">Guardar Cambios</button>
        <button onclick="cerrarPopupPasos()">Cerrar</button>
    </div>
  </div>
  
  <!-- Modal de Confirmaci√≥n de Vaciar Carrito -->
  <div id="modalVaciarCarrito" class="modal">
    <div class="modal-content">
        <p>Los ingredientes se eliminar√°n del Carrito. ¬øContinuar?</p>
        <div class="modal-buttons">
            <button onclick="vaciarCarrito()">S√≠, vaciar carrito</button>
            <button onclick="cerrarModalVaciarCarrito()">Cancelar</button>
        </div>
    </div>
  </div>
  
  <!-- Modal de √©xito - Carrito vaciado correctamente -->
  <div id="modalCarritoVaciado" class="modal">
    <div class="modal-content">
        <h2>¬°Carrito vaciado correctamente!</h2>
    </div>
  </div>
  
  <!-- Modal de √âxito -->
  <div id="modalExito" class="modal">
    <div class="modal-contenido">
        <p>¬°Ingredientes a√±adidos al carrito con √©xito!</p>
    </div>
  </div>
  
  <!-- Modal de confirmaci√≥n para eliminar seleccionados -->
  <div id="modalConfirmacionSeleccionados" class="modal">
    <div class="modal-contenido">
        <p>¬øEst√°s seguro de que quieres eliminar los elementos seleccionados?</p>
        <button onclick="confirmarEliminacionSeleccionados()">S√≠, eliminar</button>
        <button onclick="cerrarModalConfirmacionSeleccionados()">Cancelar</button>
    </div>
  </div>

  <!-- Modal de √©xito tras eliminar los elementos seleccionados -->
  <div id="modalExitoSeleccionados" class="modal">
    <div class="modal-contenido">
        <p>¬°Elementos eliminados con √©xito!</p>
    </div>
  </div>
  
  <div id="modalConfirmacionSeleccionadosDespensa" class="modal">
    <div class="modal-content">
        <h2>¬øEliminar seleccionados?</h2>
        <div class="modal-buttons">
            <button id="btnConfirmarEliminarSeleccionadosDespensa" type="button">S√≠</button>
            <button id="btnCancelarEliminarSeleccionadosDespensa" type="button">Cancelar</button>
        </div>
    </div>
 </div>
  
  <!-- Bot√≥n de Configuraci√≥n -->
  <div id="configuracion" onclick="toggleMenuConfiguracion()">‚öôÔ∏è</div>



  <!-- Men√∫ Desplegable de Configuraci√≥n -->
  <div id="menuConfiguracion" class="menu-config">
    <button onclick="abrirMenuTemas()">üé® Cambiar Tema</button>
  </div>
  
  <div id="menuTemas" class="modal">
    <div class="modal-contenido">
        <h2>Seleccionar Tema</h2>
        <button onclick="cambiarTema('original')">üíú Original</button>
        <button onclick="cambiarTema('claro')">üåû Claro</button>
        <button onclick="cambiarTema('oscuro')">üåô Oscuro</button>
    </div>
  </div>
  
  <!-- Modal Confirmaci√≥n -->
  <div id="modalConfirmacionRecuperar" class="modal">
  <div class="modal-contenido">
    <p>¬øDesea recuperar el men√∫ seleccionado?</p>
    <div class="modal-botones">
      <button id="btnConfirmarRecuperar">S√≠</button>
      <button onclick="cerrarModal('modalConfirmacionRecuperar')">No</button>
    </div>
   </div>
  </div>

  <!-- Modal √âxito -->
  <div id="modalRecuperacionExitosa" class="modal">
    <div class="modal-contenido">
      <p>¬°Men√∫ recuperado exitosamente!</p>
    </div>
  </div>
  
  <!-- Modal: Sin pasos -->
  <div id="modalSinPasos" class="modal" style="display:none;">
    <div class="modal-contenido">
        <p>Esta receta no tiene pasos todav√≠a.</p>
    </div>
  </div>
  
  
  <!-- Modal confirmaci√≥n men√∫ guardado -->
  <div id="modalConfirmacionMenu" class="modal-confirmacion">
    <div class="modal-contenido-confirmacion">
      <p>Men√∫ guardado correctamente</p>
    </div>
  </div>
  
  <!-- Modal: Men√∫ eliminado (√©xito) -->
<div id="modalMenuEliminadoExito" class="modal-confirmacion">
    <div class="modal-contenido-confirmacion">
        <p>Men√∫ eliminado correctamente</p>
    </div>
</div>


               <script>  
               
  // ===================== STORE (√∫nico punto de acceso) =====================
const Store = (() => {
  const KEYS = {
    recetas: "recetas",
    productos: "productos",
    carrito: "carrito",
    pasoAPaso: "pasoAPaso",
    menuSemana: "menuSemana",
    menusArchivados: "menusArchivados",
    temaSeleccionado: "temaSeleccionado",
    despensa: "despensa",
  };

  function get(key, fallback) {
    const k = typeof key === "string" ? key : String(key);
    const raw = localStorage.getItem(k);
    if (raw === null || raw === undefined || raw === "") return fallback;
    try { return JSON.parse(raw); } catch { return fallback; }
  }

  function set(key, value) {
    const k = typeof key === "string" ? key : String(key);
    localStorage.setItem(k, JSON.stringify(value));
    return value;
  }

  function update(key, fallback, mutatorFn) {
    const current = get(key, fallback);
    const next = mutatorFn(current) ?? current;
    set(key, next);
    return next;
  }

  return {
    KEYS,
    get, set, update,

    loadRecetas:   () => get(KEYS.recetas, []),
    saveRecetas:   (v) => set(KEYS.recetas, v),

    loadProductos: () => get(KEYS.productos, []),
    saveProductos: (v) => set(KEYS.productos, v),

    loadCarrito:   () => get(KEYS.carrito, []),
    saveCarrito:   (v) => set(KEYS.carrito, v),

    loadPasoAPaso: () => get(KEYS.pasoAPaso, []),
    savePasoAPaso: (v) => set(KEYS.pasoAPaso, v),

    loadMenuSemana: () => get(KEYS.menuSemana, {}),
    saveMenuSemana: (v) => set(KEYS.menuSemana, v),

    loadMenusArchivados: () => get(KEYS.menusArchivados, []),
    saveMenusArchivados: (v) => set(KEYS.menusArchivados, v),

   loadTema: () => get(KEYS.temaSeleccionado, "original"),
   
    saveTema: (v) => set(KEYS.temaSeleccionado, v),
    
    loadDespensa: () => get(KEYS.despensa, []),
    saveDespensa: (v) => set(KEYS.despensa, v),

    resetAll: () => {
      Object.values(KEYS).forEach(k => localStorage.removeItem(k));
    }
  };
})();



        let recetas = Store.loadRecetas();
        let productos = Store.loadProductos();    
        let pasoAPaso = Store.loadPasoAPaso();
        let carrito = Store.loadCarrito();
        let _pasoEditando = { nombreReceta: null, li: null };
        let _pasoEliminando = { nombreReceta: null, li: null };
        let despensa = Store.loadDespensa();
        // ===== DESPENSA: selecci√≥n m√∫ltiple =====
        let despensaSeleccionados = new Set(); // guarda IDs
        let modoSeleccionMultipleDespensa = false;
        let tiempoPresionadoDespensa = null;
        
        function toggleSeleccionDespensa(id, li) {
          if (!id) return;
    
          if (despensaSeleccionados.has(id)) {
              despensaSeleccionados.delete(id);
              li.classList.remove("seleccionado");
          } else {
              despensaSeleccionados.add(id);
              li.classList.add("seleccionado");
          }
    
          const btn = document.getElementById("btnEliminarSeleccionadosDespensa");
          if (btn) btn.style.display = despensaSeleccionados.size > 0 ? "block" : "none";
      }

      function salirSeleccionMultipleDespensa() {
          modoSeleccionMultipleDespensa = false;
          despensaSeleccionados.clear();
    
          document
              .querySelectorAll("#listaDespensa li.seleccionado")
              .forEach(li => li.classList.remove("seleccionado"));
    
          const btn = document.getElementById("btnEliminarSeleccionadosDespensa");
          if (btn) btn.style.display = "none";
          
      }
        
        // ===== Carrito: IDs estables =====
        function generarIdCarrito() {
            // Safari iOS moderno suele soportar crypto.randomUUID()
            if (typeof crypto !== "undefined" && crypto.randomUUID) return crypto.randomUUID();
    
            // Fallback simple (suficiente para tu caso)
            return "c_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 10);
        }

        function asegurarIdsCarrito(arr) {
          if (!Array.isArray(arr)) return arr;
    
          let cambiado = false;
    
          for (const item of arr) {
            if (!item || typeof item !== "object") continue;
            if (!item.id) {
                item.id = generarIdCarrito();
            cambiado = true;
            }
          }
    
          // ‚õîÔ∏è Ya NO guardamos aqu√≠
          // if (cambiado) Store.saveCarrito(arr);
    
          // Si quieres, puedes devolver si cambi√≥:
          arr.__idsMigrados = cambiado; // opcional (o qu√≠talo)
          return arr;
        }
        
        

        function mostrarPantalla(id) {
    // Ocultar todas las pantallas
    document.querySelectorAll('.pantalla').forEach(p => p.classList.remove('activa'));
    
    // Mostrar la pantalla seleccionada
    const pantalla = document.getElementById(id);
    if (pantalla) pantalla.classList.add('activa');
    
    // Mostrar el bot√≥n Configuraci√≥n solo en la pantalla Principal
    const btnConfig = document.getElementById('configuracion');
    if (btnConfig) {
        btnConfig.style.display = (id === 'pantalla1') ? 'block' : 'none';
    }
    
    
    aplicarTema(Store.loadTema() || "original");
    
    // ‚úÖ Paso a Paso
    if (id === 'pantalla10') {
        cargarRecetasPasoAPaso();
    }
    
    // ‚úÖ Crear men√∫: rellenar tabla con los 7 d√≠as e inputs
    if (id === "pantallaCrearMenu") {
        inicializarTablaCrearMenu();
    }
    
    // ‚úÖ Men√∫s archivados: refrescar listado/tabla
    if (id === "pantallaMenusArchivados") {
        mostrarTablaMenu();
    }
    
    // ‚úÖ Despensa: refrescar al entrar en "Ver Despensa"
    if (id === "pantallaDespensaVer") {
        mostrarDespensa();
    }
}
       
        function mostrarRecetas(tipo) {
            const listaRecetas = document.getElementById('listaRecetas');
            listaRecetas.innerHTML = '';
    
            const tituloRecetas = document.getElementById('tituloRecetas');
            if (tipo === 'Comida') {
               tituloRecetas.textContent = 'Comidas';
            } else if (tipo === 'Cena') {
                tituloRecetas.textContent = 'Cenas';
            } else {
                tituloRecetas.textContent = 'Otras Recetas';
            }
    
            const recetasFiltradas = recetas.filter(r => r.tipo === tipo);
    
            if (recetasFiltradas.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No hay recetas en esta categor√≠a';
                li.style.cursor = 'default';
                li.style.textAlign = 'center';
                li.style.opacity = '0.8';
                listaRecetas.appendChild(li);
            } else {
                recetasFiltradas.forEach((receta, index) => {
                    const li = document.createElement('li');
                    li.textContent = receta.nombre;
                    li.onclick = () => abrirPopup(receta, index);
                    listaRecetas.appendChild(li);
                });
            }
    
            mostrarPantalla('pantallaRecetas');
        }
        
        
        
        function guardarReceta() {
    const nombre = document.getElementById('nombreReceta').value.trim();
    const filas = document.querySelectorAll('#cuerpoTablaIngredientes tr');

    let ingredientes = [];
    
    filas.forEach(fila => {
        const ingrediente = fila.querySelector('.ingrediente').value.trim();
        const cantidad = fila.querySelector('.cantidad').value.trim();
        if (ingrediente && cantidad) {
            ingredientes.push({ ingrediente, cantidad });
        }
    });

    const tipo = document.getElementById('tipoComida').value;

    if (nombre && ingredientes.length > 0) {
        recetas.push({ nombre, ingredientes, tipo });
        Store.saveRecetas(recetas);

        // Agregar la receta a "Paso a Paso"
        pasoAPaso.push({ nombre });
        Store.savePasoAPaso(pasoAPaso);

        
        // Mostrar en la lista de "Paso a Paso"
        const listaPaso = document.getElementById('listaPasoAPaso');
        const li = document.createElement('li');
        li.textContent = nombre;
        li.onclick = () => abrirPopupPasos(nombre); // Hacerlo clickeable
        listaPaso.appendChild(li);

        // Limpiar formulario
        document.getElementById('nombreReceta').value = '';
        document.getElementById('tipoComida').value = '';

        // Limpiar ingredientes y volver a a√±adir 3 filas por defecto
        document.getElementById('cuerpoTablaIngredientes').innerHTML = '';
        for (let i = 0; i < 3; i++) {
            agregarFilaIngrediente();
        }

        // Mostrar modal de √©xito
        const modalRecetaGuardada = document.getElementById('modalRecetaGuardada');
        modalRecetaGuardada.style.display = 'flex';

        setTimeout(() => {
            modalRecetaGuardada.style.display = 'none';
        }, 1000);
    } else {
        alert('Por favor, completa todos los campos.');
    }
}

        
       function guardarProducto() {
    const nombre = document.getElementById('nombreProducto').value.trim();
    const cantidad = document.getElementById('cantidadProducto').value.trim();
    const fechaCaducidad = document.getElementById('fechaCaducidad').value.trim();

    if (nombre && cantidad && fechaCaducidad) {
        productos.push({ nombre, cantidad, fechaCaducidad });
        Store.saveProductos(productos);
        document.getElementById('nombreProducto').value = '';
        document.getElementById('cantidadProducto').value = '';
        document.getElementById('fechaCaducidad').value = '';

        // Mostrar el modal de √©xito
        const modalProductoGuardado = document.getElementById('modalProductoGuardado');
        modalProductoGuardado.style.display = 'flex';

        // Cerrar el modal despu√©s de 1 segundo
        setTimeout(() => {
            modalProductoGuardado.style.display = 'none';
        }, 1000);

    } else {
        alert('Por favor, completa todos los campos.');
    }
}
 
        
function verInventario() {
    const listaInventario = document.getElementById('listaInventario');
    listaInventario.innerHTML = '';

    const productosOrdenados = productos.sort((a, b) => a.nombre.localeCompare(b.nombre));

    productosOrdenados.forEach((producto, index) => {
        const fecha = new Date(producto.fechaCaducidad);
        const fechaCaducidad = `${('0' + fecha.getDate()).slice(-2)}/${('0' + (fecha.getMonth() + 1)).slice(-2)}`;

        // Crear el elemento de la lista
        const li = document.createElement('li');
        li.textContent = `${producto.nombre.toUpperCase()} | ${producto.cantidad} g | Cad.: ${fechaCaducidad}`;
        li.style.position = "relative"; // Para posicionar los botones correctamente

        // Crear botones pero ocultarlos inicialmente
        const btnEditar = document.createElement('button');
        btnEditar.textContent = 'Editar';
        btnEditar.style.display = 'none';
        btnEditar.onclick = () => editarProducto(index);

        const btnEliminar = document.createElement('button');
        btnEliminar.textContent = 'Eliminar';
        btnEliminar.style.display = 'none';
        btnEliminar.onclick = () => eliminarProducto(index);

        // Agregar botones al elemento li
        li.appendChild(btnEditar);
        li.appendChild(btnEliminar);

        // Agregar evento para alternar la visibilidad de los botones
        li.onclick = function () {
            const botonesVisibles = btnEditar.style.display === 'inline-block';

            // Ocultar botones de todos los elementos antes de mostrar/ocultar los del seleccionado
            document.querySelectorAll('#listaInventario li button').forEach(btn => btn.style.display = 'none');

            // Si ya estaban visibles, los ocultamos; si no, los mostramos
            if (!botonesVisibles) {
                btnEditar.style.display = 'inline-block';
                btnEliminar.style.display = 'inline-block';
            }
        };

        // Agregar el producto a la lista
        listaInventario.appendChild(li);
    });

    mostrarPantalla('pantallaInventario');
}

function editarProducto(index) {
    const producto = productos[index];

    // Rellenar el modal con los datos actuales del producto
    document.getElementById('editarNombre').value = producto.nombre;
    document.getElementById('editarCantidad').value = producto.cantidad;
    document.getElementById('editarFechaCaducidad').value = producto.fechaCaducidad;

    // Mostrar el modal de edici√≥n
    document.getElementById('modalEditarProducto').style.display = 'flex';

    // Guardar el √≠ndice del producto a editar
    document.getElementById('modalEditarProducto').dataset.index = index;
}

function guardarEdicionProducto() {
    const index = document.getElementById('modalEditarProducto').dataset.index;
    const nuevoNombre = document.getElementById('editarNombre').value.trim();
    const nuevaCantidad = document.getElementById('editarCantidad').value.trim();
    const nuevaFechaCaducidad = document.getElementById('editarFechaCaducidad').value.trim();

    if (nuevoNombre && nuevaCantidad && nuevaFechaCaducidad) {
        productos[index] = {
            nombre: nuevoNombre,
            cantidad: nuevaCantidad,
            fechaCaducidad: nuevaFechaCaducidad
        };

        Store.saveProductos(productos);
        verInventario(); // Actualiza la lista de inventario

        // Mostrar el modal de √©xito personalizado
        const modalExitoProducto = document.getElementById('modalExitoProducto');
        modalExitoProducto.style.display = 'block';

        // Cerrar el modal despu√©s de 1 segundo
        setTimeout(() => {
            modalExitoProducto.style.display = 'none';
        }, 1000);

        cerrarModalEditarProducto(); // Cierra el modal de edici√≥n
    } else {
        alert('Por favor, ingrese todos los detalles.');
    }
}


function cerrarModalEditarProducto() {
    document.getElementById('modalEditarProducto').style.display = 'none';

    
}

let _indiceProductoAEliminar = null;

function eliminarProducto(index) {
    _indiceProductoAEliminar = index;
    
    // Usamos la fuente correcta (tu variable global + Store.saveProductos)
    const producto = productos[index];
    const nombre = (producto?.nombre || "producto").trim();
    
    // (Opcional) si alg√∫n d√≠a a√±ades un <span id="textoConfirmacionProducto"> lo rellenar√°
    const texto = document.getElementById("textoConfirmacionProducto");
    if (texto) texto.textContent = `¬øSeguro que quieres eliminar "${nombre}"?`;
    
    const modal = document.getElementById("modalConfirmacionProducto");
    if (modal) modal.style.display = "flex";
}

// Handlers √∫nicos para el modal de confirmaci√≥n de eliminaci√≥n de producto
document.getElementById("btnCancelarEliminarProducto").onclick = () => {
    const modal = document.getElementById("modalConfirmacionProducto");
    if (modal) modal.style.display = "none";
    _indiceProductoAEliminar = null;
};

document.getElementById("btnConfirmarEliminarProducto").onclick = () => {
    if (_indiceProductoAEliminar === null) return;
    
    // Eliminar de la lista en memoria
    productos.splice(_indiceProductoAEliminar, 1);
    
    // Persistir
    Store.saveProductos(productos);
    
    // Cerrar modal + limpiar estado
    const modal = document.getElementById("modalConfirmacionProducto");
    if (modal) modal.style.display = "none";
    _indiceProductoAEliminar = null;
    
    // Refrescar inventario (tu funci√≥n real)
    verInventario();
};

        
        function verAlertas() {
    const listaAlertas = document.getElementById('listaAlertas');
    listaAlertas.innerHTML = '';

    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);

    const alertas = productos.filter(producto => {
        const fechaCaducidad = new Date(producto.fechaCaducidad);
        const diferenciaDias = Math.ceil((fechaCaducidad - hoy) / (1000 * 60 * 60 * 24));
        return diferenciaDias <= 2; // Filtrar productos a 2 d√≠as o menos de caducar
    });

    if (alertas.length === 0) {
        listaAlertas.innerHTML = '<li>No hay productos pr√≥ximos a caducar</li>';
    } else {
        alertas.forEach(producto => {
            const fecha = new Date(producto.fechaCaducidad);
            const fechaCaducidad = `${('0' + fecha.getDate()).slice(-2)}/${('0' + (fecha.getMonth() + 1)).slice(-2)}`;

            const li = document.createElement('li');
            li.textContent = `${producto.nombre.toUpperCase()} | ${producto.cantidad} g | Cad.: ${fechaCaducidad}`;
            listaAlertas.appendChild(li);
        });
    }

    mostrarPantalla('pantallaAlertas');
}

function marcarCheckbox(i) {
    const checkbox = document.getElementById(`ingrediente-${i}`);
    if (!checkbox) return;
    
    const li = checkbox.closest('li');
    if (!li) return;
    
    // Opcional: feedback visual (puedes quitarlo si no quieres estilos)
    li.style.opacity = checkbox.checked ? "1" : "0.65";
}

function abrirPopup(receta) {
    // Construimos la lista de ingredientes con cantidades en gramos
    const ingredientesList = receta.ingredientes.map((item, i) => {
        return `
      <li>
        <input type="checkbox" id="ingrediente-${i}" checked>
        ${item.ingrediente} - ${item.cantidad}g
      </li>
    `;
    }).join('');
    
    // Mostramos la lista en el popup
    document.getElementById('popupDescripcion').innerHTML = `<ul>${ingredientesList}</ul>`;
    
    // Guardamos el nombre de la receta en dataset (para eliminarla por nombre)
    const popup = document.getElementById('popup');
    popup.dataset.nombre = receta.nombre;
    
    // Mostrar el popup
    popup.style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
}       
       

        
        function cerrarPopup() {
            document.getElementById('popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function borrarReceta() {
    const nombreReceta = document.getElementById('popup').dataset.nombre; // Obtener el nombre

    if (!nombreReceta) {
        alert('Error al borrar la receta. Nombre no v√°lido.');
        return;
    }

    // Mostrar el modal de confirmaci√≥n para recetas
    document.getElementById('modalConfirmacionReceta').style.display = 'flex';
    document.getElementById('modalConfirmacionReceta').dataset.nombre = nombreReceta;
}

function confirmarEliminacionReceta() {
    const nombreReceta = document.getElementById('modalConfirmacionReceta').dataset.nombre;

    const index = recetas.findIndex(r => r.nombre === nombreReceta);
    
    if (index !== -1) {
        // Obtener el tipo de la receta antes de eliminarla
        const tipoReceta = recetas[index].tipo;

        recetas.splice(index, 1);
        Store.saveRecetas(recetas);

       
        let pasosGuardados = Store.loadPasoAPaso();
        pasosGuardados = pasosGuardados.filter(r => r.nombre !== nombreReceta);
        Store.savePasoAPaso(pasosGuardados);

        // mantener variable global sincronizada
        pasoAPaso = pasosGuardados;

        // Cerrar los modales
        cerrarModalConfirmacionReceta();
        cerrarPopup();

        // Refrescar la lista de recetas sin cambiar de pantalla
        mostrarRecetas(tipoReceta);

        // Refrescar la pantalla Paso a Paso para eliminar su registro
        actualizarPantallaPasoAPaso();

        // Mostrar mensaje de √©xito
        document.getElementById('modalEliminacionReceta').style.display = 'flex';

        setTimeout(() => {
            cerrarModalEliminacionReceta();
        }, 1000);
    } else {
        alert('Error: No se encontr√≥ la receta.');
    }
}


function cerrarModalConfirmacionReceta() {
    document.getElementById('modalConfirmacionReceta').style.display = 'none';
}

function cerrarModalEliminacionReceta() {
    document.getElementById('modalEliminacionReceta').style.display = 'none';
}


     
        
        // Inicializaci√≥n de los d√≠as de la semana
const diasSemana = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];

function inicializarTablaCrearMenu() {
    const tabla = document.getElementById("tablaMenu");
    if (!tabla) return;
    
    const tbody = tabla.querySelector("tbody");
    if (!tbody) return;
    
    // Evita duplicados si entras/sales varias veces
    tbody.innerHTML = "";
    
    diasSemana.forEach(dia => {
        const tr = document.createElement("tr");
        
        // D√≠a
        const tdDia = document.createElement("td");
        tdDia.textContent = dia;
        tr.appendChild(tdDia);
        
        // Comida
        const tdComida = document.createElement("td");
        const inputComida = document.createElement("input");
        inputComida.type = "text";
        inputComida.placeholder = "Comida del d√≠a";
        inputComida.id = `comida-${dia}`;
        tdComida.appendChild(inputComida);
        tr.appendChild(tdComida);
        
        // Cena
        const tdCena = document.createElement("td");
        const inputCena = document.createElement("input");
        inputCena.type = "text";
        inputCena.placeholder = "Cena del d√≠a";
        inputCena.id = `cena-${dia}`;
        tdCena.appendChild(inputCena);
        tr.appendChild(tdCena);
        
        tbody.appendChild(tr);
    });
}

// Funci√≥n para mostrar la tabla con los d√≠as de la semana y las columnas Comida y Cena
function mostrarTablaMenu() {
    const contenedor = document.getElementById("contenedorMenuGuardado");
    if (!contenedor) return;
    
    const archivados = Store.loadMenusArchivados() || [];
    contenedor.innerHTML = "";
    
    if (archivados.length === 0) {
        contenedor.innerHTML = '<p class="mensajeVacio">No hay men√∫s archivados.</p>';
        return;
    }
    
    archivados.forEach((menu, index) => {
        // ===== T√çTULO EDITABLE =====
        const titulo = document.createElement("h2");
        titulo.classList.add("tituloMenu");
        titulo.textContent = (menu.nombre || `Men√∫ ${index + 1}`).trim();
        titulo.contentEditable = "true";
        
        titulo.onblur = () => {
            const nuevo = titulo.textContent.trim() || `Men√∫ ${index + 1}`;
            const lista = Store.loadMenusArchivados() || [];
            if (!lista[index]) return;
            lista[index].nombre = nuevo;
            Store.saveMenusArchivados(lista);
        };
        
        contenedor.appendChild(titulo);
        
        // ===== TABLA COMPLETA =====
        const tabla = document.createElement("table");
        tabla.classList.add("tablaMenu");
        
        const thead = document.createElement("thead");
        thead.innerHTML = `
      <tr>
        <th class="celdaEncabezado">D√≠a</th>
        <th class="celdaEncabezado">Comida</th>
        <th class="celdaEncabezado">Cena</th>
      </tr>
    `;
        tabla.appendChild(thead);
        
        const tbody = document.createElement("tbody");
        diasSemana.forEach(dia => {
            const comida = (menu?.[dia]?.comida || "");
            const cena = (menu?.[dia]?.cena || "");
            
            const fila = document.createElement("tr");
            fila.innerHTML = `
        <td class="celdaEncabezado">${dia}</td>
        <td class="celdaMenu">${comida}</td>
        <td class="celdaMenu">${cena}</td>
      `;
            tbody.appendChild(fila);
        });
        
        tabla.appendChild(tbody);
        contenedor.appendChild(tabla);
        
        // ===== BOTONES =====
        const contBotones = document.createElement("div");
        contBotones.classList.add("botones-menu-semanal");
        
        const btnRecuperar = document.createElement("button");
        btnRecuperar.textContent = "Recuperar";
        btnRecuperar.classList.add("btn-verde");
        btnRecuperar.onclick = () => recuperarMenu(index);
        
        const btnEliminar = document.createElement("button");
        btnEliminar.textContent = "Eliminar";
        btnEliminar.style.backgroundColor = "red";
        btnEliminar.style.color = "white";
        btnEliminar.onclick = () => eliminarMenuArchivado(index);
        
        contBotones.appendChild(btnRecuperar);
        contBotones.appendChild(btnEliminar);
        contenedor.appendChild(contBotones);
    });
    
    // Reaplicar tema al contenido generado
    aplicarTema(Store.loadTema() || "original");
}



function guardarMenu() {
    const menuSemana = Store.loadMenuSemana() || {};
    
    diasSemana.forEach(dia => {
        const comidaInput = document.getElementById(`comida-${dia}`);
        const cenaInput = document.getElementById(`cena-${dia}`);
        const comida = (comidaInput?.value || "").trim();
        const cena = (cenaInput?.value || "").trim();
        
        if (comida || cena) {
            menuSemana[dia] = { comida, cena };
        } else {
            // Si estaban vac√≠os, dejamos el d√≠a limpio
            delete menuSemana[dia];
        }
        
        // Limpiar inputs
        if (comidaInput) comidaInput.value = "";
        if (cenaInput) cenaInput.value = "";
    });
    
    // Mantener nombre si ya exist√≠a
    if (!menuSemana.nombre) {
        const archivados = Store.loadMenusArchivados() || [];
        menuSemana.nombre = `Men√∫ ${archivados.length + 1}`;
    }
    
    if (Object.keys(menuSemana).filter(k => k !== "nombre").length > 0) {
        Store.saveMenuSemana(menuSemana);
        mostrarModalConfirmacionMenu();
        mostrarMenuSemanal(menuSemana);
    } else {
        alert("Por favor, ingrese al menos una comida o cena en alg√∫n d√≠a.");
    }
}

function mostrarMenuSemanal(menu) {
    const contenedor = document.getElementById("contenedorMenuSemanal");
    contenedor.innerHTML = "";
    
    const botones = document.getElementById("botonesMenuSemanal");
    
    const tieneContenido = diasSemana.some(dia => {
        const comida = (menu?.[dia]?.comida || "").trim();
        const cena = (menu?.[dia]?.cena || "").trim();
        return comida || cena;
    });
    
    // ‚úÖ Si no hay men√∫ real, mostramos mensaje y ocultamos botones
    if (!tieneContenido) {
        contenedor.innerHTML = `<p class="mensajeVacio">No hay men√∫s guardados.</p>`;
        if (botones) botones.style.display = "none";
        aplicarTema(Store.loadTema?.() || "original");
        return;
    }
    
    // Nombre (si hay contenido, s√≠ tiene sentido)
    const archivados = Store.loadMenusArchivados() || [];
    const nombrePredeterminado = (menu?.nombre || "").trim() || `Men√∫ ${archivados.length + 1}`;
    
    // T√≠tulo editable
    const tituloMenu = document.createElement("h2");
    tituloMenu.textContent = nombrePredeterminado;
    tituloMenu.contentEditable = "true";
    tituloMenu.classList.add("tituloMenu");
    
    tituloMenu.onblur = function() {
        const menuActual = Store.loadMenuSemana() || {};
        const nuevoNombre = (tituloMenu.textContent || "").trim() || nombrePredeterminado;
        menuActual.nombre = nuevoNombre;
        Store.saveMenuSemana(menuActual);
        tituloMenu.textContent = nuevoNombre;
    };
    
    contenedor.appendChild(tituloMenu);
    
    // Tabla
    const tabla = document.createElement("table");
    tabla.id = "tablaMenuSemanal";
    tabla.classList.add("tablaMenu");
    
    const thead = document.createElement("thead");
    thead.innerHTML = `
    <tr>
      <th class="celdaEncabezado">D√≠a</th>
      <th class="celdaEncabezado">Comida</th>
      <th class="celdaEncabezado">Cena</th>
    </tr>
  `;
    tabla.appendChild(thead);
    
    const tbody = document.createElement("tbody");
    diasSemana.forEach(dia => {
        const comida = menu?.[dia]?.comida || "";
        const cena = menu?.[dia]?.cena || "";
        const fila = document.createElement("tr");
        fila.innerHTML = `
      <td class="celdaEncabezado">${dia}</td>
      <td class="celdaMenu">${comida}</td>
      <td class="celdaMenu">${cena}</td>
    `;
        tbody.appendChild(fila);
    });
    
    tabla.appendChild(tbody);
    contenedor.appendChild(tabla);
    
    aplicarTema(Store.loadTema?.() || "original");
    if (botones) botones.style.display = "flex";
}


function abrirModalEditar() {
  let menu = Store.loadMenuSemana();
  if (!menu || Object.keys(menu).length === 0) {
    alert("No hay men√∫ para editar");
    return;
  }
  const tbody = document.querySelector("#tablaEdicion tbody");
  tbody.innerHTML = "";
  
  diasSemana.forEach(dia => {
    const comida = menu[dia] ? menu[dia].comida : "";
    const cena = menu[dia] ? menu[dia].cena : "";
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${dia}</td>
      <td><input type="text" id="editComida-${dia}" value="${comida}"></td>
      <td><input type="text" id="editCena-${dia}" value="${cena}"></td>
    `;
    tbody.appendChild(fila);
  });
  
  document.getElementById("modalEditar").style.display = "flex";
}



function cerrarModalEditar() {
  document.getElementById("modalEditar").style.display = "none";
}

function guardarEdicionMenu() {
  const menuEditado = {};
  
  diasSemana.forEach(dia => {
    const comida = document.getElementById(`editComida-${dia}`).value.trim();
    const cena = document.getElementById(`editCena-${dia}`).value.trim();
    menuEditado[dia] = { comida, cena };
  });
  
  Store.saveMenuSemana(menuEditado);
  cerrarModalEditar();
  mostrarMenuSemanal(menuEditado);
}


function archivarMenuActual() {
    const menuActual = Store.loadMenuSemana() || {};
    
    // Validar contenido real
    const tieneContenido = diasSemana.some(dia => {
        const comida = (menuActual?.[dia]?.comida || "").trim();
        const cena = (menuActual?.[dia]?.cena || "").trim();
        return comida || cena;
    });
    
    if (!tieneContenido) {
        alert("No hay men√∫ semanal para archivar.");
        return;
    }
    
    // Asegurar nombre
    const archivados = Store.loadMenusArchivados() || [];
    const nombre = (menuActual.nombre || "").trim() || `Men√∫ ${archivados.length + 1}`;
    
    const menuArchivado = {
        ...menuActual,
        nombre,
        fechaArchivado: new Date().toISOString()
    };
    
    archivados.push(menuArchivado);
    Store.saveMenusArchivados(archivados);
    
    // Vaciar men√∫ semanal actual
    Store.saveMenuSemana({});
    
    // ‚úÖ Refrescar pantalla men√∫ semanal (ahora mostrar√° "No hay men√∫s guardados")
    renderMenuSemanalActual();
    
    // Modal √©xito + refrescar archivados
    mostrarModalArchivadoExitoso();
    mostrarTablaMenu();
}


function mostrarMenusArchivados() {
    const contenedor = document.getElementById("pantallaMenusArchivados");
    contenedor.innerHTML = `<h1>Men√∫s Archivados</h1>`;

    const menusArchivados = Store.loadMenusArchivados() || [];
    if (menusArchivados.length === 0) {
        contenedor.innerHTML += `<p class="mensajeVacio">No hay men√∫s archivados.</p>`;
    } else {
        menusArchivados.forEach((menu, index) => {
            const tituloMenu = document.createElement("h2");
            tituloMenu.textContent = menu.nombre || `Men√∫ ${index + 1}`;
            tituloMenu.classList.add("tituloMenu");

            contenedor.appendChild(tituloMenu);

            const tabla = document.createElement("table");
            tabla.classList.add("tablaMenu");

            const thead = document.createElement("thead");
            thead.innerHTML = `
                <tr>
                    <th class="celdaEncabezado">D√≠a</th>
                    <th class="celdaEncabezado">Comida</th>
                    <th class="celdaEncabezado">Cena</th>
                </tr>
            `;
            tabla.appendChild(thead);

            const tbody = document.createElement("tbody");
            diasSemana.forEach(dia => {
                const comida = menu[dia] ? menu[dia].comida : "";
                const cena = menu[dia] ? menu[dia].cena : "";
                const fila = document.createElement("tr");

                fila.innerHTML = `
                    <td class="celdaEncabezado">${dia}</td>
                    <td class="celdaMenu">${comida}</td>
                    <td class="celdaMenu">${cena}</td>
                `;
                tbody.appendChild(fila);
            });

            tabla.appendChild(tbody);
            contenedor.appendChild(tabla);

            // Contenedor de botones
            const contenedorBotones = document.createElement("div");
            contenedorBotones.classList.add("botones-menu-semanal");

            // Bot√≥n Recuperar
            const btnRecuperar = document.createElement("button");
            btnRecuperar.textContent = "Recuperar";
            btnRecuperar.onclick = () => recuperarMenu(index);
            btnRecuperar.classList.add("btn-verde"); // Aplicar clase
            contenedorBotones.appendChild(btnRecuperar);


            // Bot√≥n Eliminar
            const btnEliminar = document.createElement("button");
            btnEliminar.textContent = "Eliminar";
            btnEliminar.onclick = () => eliminarMenuArchivado(index);
            btnEliminar.style.backgroundColor = "red"; // Color rojo para eliminar
            btnEliminar.style.color = "white";
            contenedorBotones.appendChild(btnEliminar);

            contenedor.appendChild(contenedorBotones);
        });
    }

    // **Asegurar que el bot√≥n "Volver" siempre se muestre**
    const btnVolver = document.createElement("button");
    btnVolver.textContent = "Volver";
    btnVolver.onclick = () => mostrarPantalla('pantalla6'); // Ajusta esto seg√∫n la pantalla correcta
    btnVolver.style.marginTop = "15px";
    contenedor.appendChild(btnVolver);

    // Aplicar el tema actual al nuevo contenido generado
    aplicarTema(Store.loadTema());
}

let indiceMenuARecuperar = null;
let indiceMenuAEliminar = null;

function recuperarMenu(index) {
    indiceMenuARecuperar = index;
    document.getElementById("modalConfirmacionRecuperar").style.display = "flex";
}

document.getElementById("btnConfirmarRecuperar").onclick = () => {
    if (indiceMenuARecuperar === null) return;
    
    const menusArchivados = Store.loadMenusArchivados() || [];
    const menuRecuperado = menusArchivados.splice(indiceMenuARecuperar, 1)[0];
    if (!menuRecuperado) return;
    
    // 1) Guardar como men√∫ actual
    Store.saveMenuSemana(menuRecuperado);
    
    // 2) Guardar archivados SIN el recuperado
    Store.saveMenusArchivados(menusArchivados);
    
    // 3) Refrescar pantallas
    mostrarMenuSemanal(menuRecuperado);
    mostrarTablaMenu();
    
    cerrarModal("modalConfirmacionRecuperar");
    
    // Modal de √©xito
    const modalExito = document.getElementById("modalRecuperacionExitosa");
    modalExito.style.display = "flex";
    setTimeout(() => (modalExito.style.display = "none"), 1000);
    
    indiceMenuARecuperar = null;
    
    // Llevarte a men√∫ semanal (opcional pero recomendable)
    mostrarPantalla("pantallaMenuSemanal");
};

document.getElementById("btnCancelarEliminarMenu").onclick = () => {
    document.getElementById("modalConfirmacionEliminarMenu").style.display = "none";
    indiceMenuAEliminar = null;
};

document.getElementById("btnConfirmarEliminarMenu").onclick = () => {
    if (indiceMenuAEliminar === null) return;
    
    const archivados = Store.loadMenusArchivados() || [];
    archivados.splice(indiceMenuAEliminar, 1);
    Store.saveMenusArchivados(archivados);
    
    document.getElementById("modalConfirmacionEliminarMenu").style.display = "none";
    indiceMenuAEliminar = null;
    
    // refrescar la pantalla de archivados
    mostrarTablaMenu();
    
    // ‚úÖ modal de √©xito
    mostrarModalMenuEliminadoExito();
};

function cerrarModal(id) {
    document.getElementById(id).style.display = "none";
}

function cargarMenuArchivado(index) {
    const archivados = Store.loadMenusArchivados() || [];
    const menu = archivados[index];
    if (!menu) return;
    
    // Cargamos como men√∫ actual
    Store.saveMenuSemana(menu);
    mostrarMenuSemanal(menu);
    
    alert(`Men√∫ "${menu.nombre || "sin nombre"}" cargado como men√∫ semanal.`);
}

function eliminarMenuArchivado(index) {
    indiceMenuAEliminar = index;
    
    const archivados = Store.loadMenusArchivados() || [];
    const menu = archivados[index];
    const nombre = (menu?.nombre || "Men√∫").trim();
    
    const texto = document.getElementById("textoConfirmacionEliminarMenu");
    if (texto) texto.textContent = `¬øSeguro que quieres eliminar "${nombre}"?`;
    
    document.getElementById("modalConfirmacionEliminarMenu").style.display = "flex";
}


function anadirAlCarrito() {
    const nombre = document.getElementById('nombreIngrediente').value.trim();
    const cantidadRaw = document.getElementById('cantidadIngrediente').value.trim();
    
    // Cantidad opcional:
    // - ""  -> null (no hay cantidad)
    // - "12"-> 12
    const cantidad = (cantidadRaw === "") ? null : Number(cantidadRaw);
    
    // Validaciones
    if (!nombre) {
        alert('Por favor, ingresa un nombre v√°lido.');
        return;
    }
    if (cantidadRaw !== "" && (!Number.isFinite(cantidad) || cantidad < 0)) {
        alert('Cantidad no v√°lida. D√©jala vac√≠a o pon un n√∫mero >= 0.');
        return;
    }
    
    let carritoLocal = Store.loadCarrito() || [];
    
    const existente = carritoLocal.find(item =>
        (item.nombre || "").toLowerCase() === nombre.toLowerCase()
    );
    
    if (existente) {
        // Si ya existe:
        // - si llega cantidad null -> no tocamos la cantidad existente
        // - si llega n√∫mero -> sumamos (tratando null/"" como 0)
        if (cantidad !== null) {
            const base = Number(existente.cantidad);
            existente.cantidad = (Number.isFinite(base) ? base : 0) + cantidad;
        }
    } else {
        // Si no existe, lo creamos (con cantidad null si no se indic√≥)
        carritoLocal.push({ id: generarIdCarrito(), nombre, cantidad });
    }
    
    // ‚úÖ asegurar IDs antes de guardar (por si hay datos viejos sin id)
    asegurarIdsCarrito(carritoLocal);
    
    // ‚úÖ Guardar + refrescar (sin llamar mostrarCarrito() aqu√≠)
    saveCarritoAndRefresh(carritoLocal);
    
    // Limpiar campos
    document.getElementById('nombreIngrediente').value = '';
    document.getElementById('cantidadIngrediente').value = '';
    
    // Modal √©xito
    const modalIngredienteGuardado = document.getElementById('modalIngredienteGuardado');
    modalIngredienteGuardado.style.display = 'flex';
    setTimeout(() => (modalIngredienteGuardado.style.display = 'none'), 1000);
}

let seleccionados = new Set();
let modoSeleccionMultiple = false;
let tiempoPresionado = null;
let paginaActual = 1;
const elementosPorPagina = 8; // Mostramos 8 elementos por p√°gina
let paginaDespensaActual = 1;
const elementosPorPaginaDespensa = 8;

function normalizarCantidad(cantidad) {
    // permite: null, "", undefined => null
    if (cantidad === null || cantidad === "" || typeof cantidad === "undefined") return null;
    
    const n = Number(cantidad);
    // NaN o infinito => null
    if (!Number.isFinite(n)) return null;
    
    // 0 lo tratamos como "sin cantidad" para UI
    if (n === 0) return null;
    
    return n;
}

function normalizarProductoCarrito(p) {
    // nombre siempre string
    const nombre = (p?.nombre ?? "").toString();
    
    // id obligatorio (si falta lo generamos)
    const id = (p?.id ?? "").toString().trim() || generarIdCarrito();
    
    return {
        id,
        nombre,
        cantidad: normalizarCantidad(p?.cantidad),
    };
}

function getCarritoSeguro() {
    const raw = Store.loadCarrito() || [];
    
    let cambiado = false;
    
    const normalizado = raw.map(p => {
        const beforeId = p?.id;
        const beforeNombre = p?.nombre;
        const beforeCant = p?.cantidad;
        
        const n = normalizarProductoCarrito(p);
        
        // Detectar cambios ‚Äúreales‚Äù
        if (beforeId !== n.id) cambiado = true;
        if ((beforeNombre ?? "") !== n.nombre) cambiado = true;
        
        const a = normalizarCantidad(beforeCant);
        const b = n.cantidad;
        if (a !== b) cambiado = true;
        
        return n;
    });
    
    asegurarIdsCarrito(normalizado);
    
    // Guardar SOLO si cambi√≥ algo (normalizaci√≥n o IDs)
    if (cambiado || normalizado.__idsMigrados) {
        Store.saveCarrito(normalizado);
    }
    
    return normalizado;
}


function mostrarCarrito() {
    const listaCarrito = document.getElementById('listaCarrito');
    const btnVaciar = document.getElementById('btnVaciarCarrito');
    const btnEliminarSeleccionados = document.getElementById('btnEliminarSeleccionados');
    const paginacion = document.getElementById('paginacionCarrito');
    
    carrito = getCarritoSeguro();
    seleccionados.clear();
    modoSeleccionMultiple = false;
    
    // Vista ordenada SIN alterar el array real (mantiene √≠ndices correctos)
    const carritoOrdenado = carrito
        .map((item, idx) => ({ item, idx })) // guardo el √≠ndice real
        .sort((a, b) => (a.item.nombre || "").localeCompare(b.item.nombre || ""));
    
    listaCarrito.innerHTML = '';
    
    if (carrito.length === 0) {
        const liVacio = document.createElement('li');
        liVacio.textContent = 'El carrito est√° vac√≠o';
        liVacio.style.color = 'white';
        liVacio.style.textAlign = 'center';
        liVacio.style.fontSize = '18px';
        liVacio.style.marginTop = '20px';
        liVacio.style.cursor = 'default';
        listaCarrito.appendChild(liVacio);
    } else {
        
        const totalPaginas = Math.ceil(carritoOrdenado.length / elementosPorPagina);
        if (paginaActual > totalPaginas) paginaActual = totalPaginas;
        if (paginaActual < 1) paginaActual = 1;
        
        // Calculamos el √≠ndice de inicio y fin para la paginaci√≥n
        const inicio = (paginaActual - 1) * elementosPorPagina;
        const fin = inicio + elementosPorPagina;
        const elementosPagina = carritoOrdenado.slice(inicio, fin);
        
        elementosPagina.forEach((entry) => {
            const producto = entry.item; // producto real
            const realIndex = entry.idx; // √≠ndice real en 'carrito'
            const realId = producto.id; // ‚úÖ el ID estable del item.
            
            const li = document.createElement('li');
            
            // Texto del item (arriba)
            const texto = document.createElement('div');
            const cant = (producto.cantidad === null || producto.cantidad === "" || typeof producto.cantidad === "undefined") ?
                null :
                Number(producto.cantidad);
            
            texto.textContent = (cant === null || !Number.isFinite(cant) || cant === 0) ?
                `${(producto.nombre || "").toUpperCase()}` :
                `${(producto.nombre || "").toUpperCase()} | ${cant} g`;
            li.appendChild(texto);
            
            // Contenedor de acciones (debajo, en una sola l√≠nea)
            const acciones = document.createElement('div');
            acciones.className = 'acciones-carrito'; // usa el CSS
            
            const btnEditar = document.createElement('button');
            btnEditar.textContent = 'Editar';
            btnEditar.type = 'button';
            btnEditar.onclick = (e) => {
                e.stopPropagation();
                abrirModalEdicionPorId(realId);
            };
            
            const btnEliminar = document.createElement('button');
            btnEliminar.textContent = 'Eliminar';
            btnEliminar.type = 'button';
            btnEliminar.onclick = (e) => {
                e.stopPropagation();
                abrirModalConfirmacionPorId(realId);
            };
            
            acciones.appendChild(btnEditar);
            acciones.appendChild(btnEliminar);
            li.appendChild(acciones);
            
            li.addEventListener('click', function() {
              if (modoSeleccionMultiple) {
                toggleSeleccion(realId, li);
              } else {
                const estaVisible = acciones.style.display === 'flex';
        
                document.querySelectorAll('#listaCarrito .acciones-carrito')
                  .forEach(div => div.style.display = 'none');
        
                if (!estaVisible) acciones.style.display = 'flex';
              }
            });

            li.addEventListener('touchstart', function() {
              tiempoPresionado = setTimeout(() => {
                modoSeleccionMultiple = true;
                toggleSeleccion(realId, li);
              }, 350);
            });

            li.addEventListener('touchend', function() {
              clearTimeout(tiempoPresionado);
            });
            
            listaCarrito.appendChild(li);
        });
    }
    
    btnVaciar.style.display = carrito.length > 0 ? 'block' : 'none';
    
    // Actualizar paginaci√≥n
    actualizarPaginacion();
}

function actualizarPaginacion() {
    const paginacion = document.getElementById('paginacionCarrito');
    if (!paginacion) return;
    
    paginacion.innerHTML = '';
    
    const totalPaginas = Math.ceil(carrito.length / elementosPorPagina);
    
    // Si no hay m√°s de 1 p√°gina, ocultamos el bloque
    if (totalPaginas <= 1) {
        paginacion.style.display = 'none';
        return;
    }
    
    // Si la p√°gina actual se ha quedado fuera (por borrar/a√±adir), la ajustamos
    if (paginaActual > totalPaginas) paginaActual = totalPaginas;
    if (paginaActual < 1) paginaActual = 1;
    
    paginacion.style.display = 'block';
    
    if (paginaActual > 1) {
        const btnAnterior = document.createElement('button');
        btnAnterior.textContent = '‚Üê Anterior';
        btnAnterior.onclick = () => {
            paginaActual--;
            mostrarCarrito();
        };
        paginacion.appendChild(btnAnterior);
    }
    
    const indicadorPagina = document.createElement('span');
    indicadorPagina.textContent = ` P√°gina ${paginaActual} de ${totalPaginas} `;
    paginacion.appendChild(indicadorPagina);
    
    if (paginaActual < totalPaginas) {
        const btnSiguiente = document.createElement('button');
        btnSiguiente.textContent = 'Siguiente ‚Üí';
        btnSiguiente.onclick = () => {
            paginaActual++;
            mostrarCarrito();
        };
        paginacion.appendChild(btnSiguiente);
    }
}

function actualizarPaginacionDespensa(totalItems) {
    const pag = document.getElementById('paginacionDespensa');
    if (!pag) return;
    
    pag.innerHTML = '';
    
    const totalPaginas = Math.ceil(totalItems / elementosPorPaginaDespensa);
    
    if (totalPaginas <= 1) {
        pag.style.display = 'none';
        return;
    }
    
    if (paginaDespensaActual > totalPaginas) paginaDespensaActual = totalPaginas;
    if (paginaDespensaActual < 1) paginaDespensaActual = 1;
    
    pag.style.display = 'block';
    
    if (paginaDespensaActual > 1) {
        const btnAnterior = document.createElement('button');
        btnAnterior.textContent = '‚Üê Anterior';
        btnAnterior.onclick = () => {
            paginaDespensaActual--;
            mostrarDespensa();
        };
        pag.appendChild(btnAnterior);
    }
    
    const indicador = document.createElement('span');
    indicador.textContent = ` P√°gina ${paginaDespensaActual} de ${totalPaginas} `;
    pag.appendChild(indicador);
    
    if (paginaDespensaActual < totalPaginas) {
        const btnSiguiente = document.createElement('button');
        btnSiguiente.textContent = 'Siguiente ‚Üí';
        btnSiguiente.onclick = () => {
            paginaDespensaActual++;
            mostrarDespensa();
        };
        pag.appendChild(btnSiguiente);
    }
}


// ‚úÖ Selecci√≥n m√∫ltiple por ID (robusta con orden/paginaci√≥n)
function toggleSeleccion(id, elemento) {
    if (!id) return;
    
    if (seleccionados.has(id)) {
        seleccionados.delete(id);
        elemento.style.backgroundColor = '';
    } else {
        seleccionados.add(id);
        elemento.style.backgroundColor = 'rgba(173, 216, 230, 0.7)';
    }
    
    const btn = document.getElementById('btnEliminarSeleccionados');
    if (btn) btn.style.display = seleccionados.size > 0 ? 'block' : 'none';
}


function abrirModalConfirmacionSeleccionados() {
    document.getElementById('modalConfirmacionSeleccionados').style.display = 'flex';
}

function cerrarModalConfirmacionSeleccionados() {
    document.getElementById('modalConfirmacionSeleccionados').style.display = 'none';
}


function confirmarEliminacionSeleccionados() {
    const carritoActual = getCarritoSeguro();
    
    const carritoFiltrado = carritoActual.filter(
        producto => !seleccionados.has(producto.id)
    );
    
    saveCarritoAndRefresh(carritoFiltrado);
    
    seleccionados.clear();
    modoSeleccionMultiple = false;
    
    const btn = document.getElementById('btnEliminarSeleccionados');
    if (btn) btn.style.display = 'none';
    
    cerrarModalConfirmacionSeleccionados();
    mostrarModalExitoSeleccionados();
}

function abrirModalConfirmacion(index) {
    const carritoActual = Store.loadCarrito() || [];
    const producto = carritoActual[index];
    if (!producto || !producto.id) return;
    abrirModalConfirmacionPorId(producto.id);
}


function confirmarEliminacionCarrito() {
    const modal = document.getElementById('modalConfirmacionCarrito');
    if (!modal) return;
    
    const id = modal.dataset.id;
    if (!id) return;
    
    const carritoActual = getCarritoSeguro();
    const nuevo = carritoActual.filter(p => p && p.id !== id);
    
   saveCarritoAndRefresh(nuevo);
    
    cerrarModalConfirmacionCarrito();
}


function cerrarModalConfirmacionCarrito() {
    const modal = document.getElementById('modalConfirmacionCarrito');
    if (!modal) return;
    
    modal.style.display = 'none';
    delete modal.dataset.id;
}

function abrirModalConfirmacionSeleccionadosDespensa() {
    const m = document.getElementById("modalConfirmacionSeleccionadosDespensa");
    if (m) m.style.display = "flex";
}

function cerrarModalConfirmacionSeleccionadosDespensa() {
    const m = document.getElementById("modalConfirmacionSeleccionadosDespensa");
    if (m) m.style.display = "none";
}

function abrirModalEdicion(index) {
    const carritoActual = Store.loadCarrito() || [];
    const producto = carritoActual[index];
    if (!producto || !producto.id) return;
    abrirModalEdicionPorId(producto.id);
}


function abrirModalConfirmacionPorId(id) {
    const modal = document.getElementById('modalConfirmacionCarrito');
    if (!modal) return;
    modal.style.display = 'flex';
    modal.dataset.id = id;
}

function abrirModalEdicionPorId(id) {
    const carritoActual = getCarritoSeguro();
    const producto = carritoActual.find(p => p && p.id === id);
    if (!producto) return;
    
    document.getElementById('editarNombreCarrito').value = producto.nombre || "";
    const inputCant = document.getElementById('editarCantidadCarrito');
    if (inputCant) {
        inputCant.value =
            (producto.cantidad === null || typeof producto.cantidad === "undefined") ?
            "" :
            String(producto.cantidad);
    }
    
    const modal = document.getElementById('modalEditarCarrito');
    if (!modal) return;
    modal.dataset.id = id;
    modal.style.display = 'flex';
}


function guardarEdicionCarrito() {
    const modal = document.getElementById('modalEditarCarrito');
    const id = modal?.dataset?.id;
    
    const nuevoNombre = document.getElementById('editarNombreCarrito').value.trim();
    const cantidadRaw = document.getElementById('editarCantidadCarrito').value.trim();
    
    if (!id) return;
    
    if (!nuevoNombre) {
        alert("El nombre no puede estar vac√≠o.");
        return;
    }
    
    // Cantidad opcional: vac√≠o => null
    let nuevaCantidad = null;
    if (cantidadRaw !== "") {
        const n = Number(cantidadRaw.replace(",", "."));
        if (!Number.isFinite(n) || n < 0) {
            alert("Cantidad inv√°lida. D√©jala vac√≠a o escribe un n√∫mero >= 0.");
            return;
        }
        nuevaCantidad = n;
    }
    
    const carritoActual = getCarritoSeguro();
    const item = carritoActual.find(p => p && p.id === id);
    if (!item) return;
    
    item.nombre = nuevoNombre;
    item.cantidad = nuevaCantidad;
    
    // ‚úÖ Guardar + refrescar (evita duplicar l√≥gica)
    saveCarritoAndRefresh(carritoActual);
    
    document.getElementById('modalEditarCarrito').style.display = 'none';
    
    const modalEdicionCarrito = document.getElementById('modalEdicionCarrito');
    if (modalEdicionCarrito) {
        modalEdicionCarrito.style.display = 'flex';
        setTimeout(() => { modalEdicionCarrito.style.display = 'none'; }, 900);
    }
}


function cerrarModalEdicion() {
    document.getElementById('modalEditarCarrito').style.display = 'none';
}


function agregarFilaIngrediente() {
    const cuerpoTabla = document.getElementById('cuerpoTablaIngredientes');
    const fila = document.createElement('tr');

    fila.innerHTML = `
        <td><input type="text" class="ingrediente" placeholder="Ingrediente" required></td>
        <td><input type="number" class="cantidad" placeholder="Cantidad (g)" min="1" required></td>
        <td><button onclick="eliminarFilaIngrediente(this)">‚ùå</button></td>
    `;

    cuerpoTabla.appendChild(fila);
}

// Funci√≥n para eliminar una fila de ingrediente
function eliminarFilaIngrediente(boton) {
    boton.parentElement.parentElement.remove();
}

// Agregar 3 filas por defecto al cargar la p√°gina
document.addEventListener('DOMContentLoaded', () => {
    for (let i = 0; i < 3; i++) {
        agregarFilaIngrediente();
    }
});

function abrirPopupPasos(nombreReceta) {
  const popupPasos = document.getElementById('popupPasos');
  const overlayPasos = document.getElementById('overlayPasos');
  const listaPasos = document.getElementById('listaPasosGuardados');
  const textarea = document.getElementById('textareaPasos');

  listaPasos.innerHTML = '';
  textarea.value = '';

  const recetasGuardadas = Store.loadPasoAPaso();
  const receta = recetasGuardadas.find(r => r.nombre === nombreReceta);

  if (receta?.pasos) {
    const pasosArray = receta.pasos.split('\n');

    pasosArray.forEach((paso) => {
      const t = (paso || '').trim();
      if (!t) return;

      const li = document.createElement('li');
      li.innerHTML = `<strong></strong> <span class="textoPaso"></span>`;
      li.querySelector('.textoPaso').textContent = t;

      const btnEditar = document.createElement('button');
      btnEditar.textContent = 'Editar';
      btnEditar.classList.add('btnEditar');
      btnEditar.style.display = 'none';
      btnEditar.onclick = (e) => {
        e.stopPropagation();
        abrirModalEditarPaso(nombreReceta, li);
      };

      const btnEliminar = document.createElement('button');
      btnEliminar.textContent = 'Eliminar';
      btnEliminar.classList.add('btnEliminar');
      btnEliminar.style.display = 'none';
      btnEliminar.onclick = (e) => {
        e.stopPropagation();
        abrirModalEliminarPaso(nombreReceta, li);
      };

      const divBotones = document.createElement('div');
      divBotones.style.display = 'inline-block';
      divBotones.style.marginLeft = '10px';
      divBotones.appendChild(btnEditar);
      divBotones.appendChild(btnEliminar);

      li.onclick = () => toggleAccionesPaso(li);

      li.appendChild(divBotones);
      listaPasos.appendChild(li);
    });
  }

  popupPasos.dataset.nombre = nombreReceta;

  renumerarPasos();
  cerrarAccionesPasos();

  overlayPasos.onclick = () => {
    cerrarAccionesPasos();
    cerrarPopupPasos();
  };

  listaPasos.onclick = (e) => {
    if (e.target === listaPasos) cerrarAccionesPasos();
  };

  // Enter agrega el paso (Shift+Enter hace salto de l√≠nea)
  textarea.onkeydown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      agregarPaso();
    }
  };

  popupPasos.style.display = 'block';
  overlayPasos.style.display = 'block';

  // üëá IMPORTANTE: ya NO hacemos textarea.focus()
}


function guardarCambiosPasos() {
    const popupPasos = document.getElementById('popupPasos');
    const nombreReceta = popupPasos.dataset.nombre;
    const listaPasos = document.getElementById('listaPasosGuardados');
    
    const pasosTexto = Array.from(
        listaPasos.querySelectorAll('li .textoPaso')
    )
    .map(span => span.textContent.trim())
    .filter(Boolean)
    .join('\n');
    
    // ‚úÖ Cargar, modificar y guardar el MISMO array
    let recetasGuardadas = Store.loadPasoAPaso();
    let receta = recetasGuardadas.find(r => r.nombre === nombreReceta);
    
    if (receta) {
        receta.pasos = pasosTexto;
    } else {
        recetasGuardadas.push({ nombre: nombreReceta, pasos: pasosTexto });
    }
    
    Store.savePasoAPaso(recetasGuardadas);
    pasoAPaso = recetasGuardadas; // mantener global sincronizada
    
    cerrarPopupPasos();
    mostrarExitoPasos();
}

function editarPaso(nombreReceta, li) {
    // En vez de prompt()
    abrirModalEditarPaso(nombreReceta, li);
}

function eliminarPaso(nombreReceta, li) {
    const listaPasos = document.getElementById('listaPasosGuardados');
    if (!li) return;
    
    // quitar del DOM
    li.remove();
    
    // renumerar
    renumerarPasos();
    
    // guardar desde la UI
    const pasosTexto = Array.from(listaPasos.querySelectorAll('li .textoPaso'))
        .map(span => span.textContent.trim())
        .filter(Boolean)
        .join('\n');
    
    let recetasGuardadas = Store.loadPasoAPaso();
    let receta = recetasGuardadas.find(r => r.nombre === nombreReceta);
    
    if (receta) receta.pasos = pasosTexto;
    else recetasGuardadas.push({ nombre: nombreReceta, pasos: pasosTexto });
    
    Store.savePasoAPaso(recetasGuardadas);
    pasoAPaso = recetasGuardadas;
}

function confirmarEliminarPaso(nombreReceta, li) {
    // En vez de confirm()
    abrirModalEliminarPaso(nombreReceta, li);
}

function cerrarPopupPasos() {
    const popupPasos = document.getElementById('popupPasos');
    const overlayPasos = document.getElementById('overlayPasos');
    const listaPasos = document.getElementById('listaPasosGuardados');
    const textarea = document.getElementById('textareaPasos');
    
    cerrarAccionesPasos();
    
    if (listaPasos) listaPasos.innerHTML = '';
    if (textarea) textarea.value = '';
    
    if (popupPasos) popupPasos.style.display = 'none';
    if (overlayPasos) overlayPasos.style.display = 'none';
    
    if (overlayPasos) overlayPasos.onclick = null;
    if (listaPasos) listaPasos.onclick = null;
    if (textarea) textarea.onkeydown = null; // ‚úÖ importante
}

function agregarPaso() {
  const textarea = document.getElementById('textareaPasos');
  const listaPasos = document.getElementById('listaPasosGuardados');
  const nuevoPaso = textarea.value.trim();
  if (!nuevoPaso) return;

  const nombreReceta = document.getElementById('popupPasos').dataset.nombre;

  const li = document.createElement('li');
  li.innerHTML = `<strong></strong> <span class="textoPaso"></span>`;
  li.querySelector('.textoPaso').textContent = nuevoPaso;

  const btnEditar = document.createElement('button');
  btnEditar.textContent = 'Editar';
  btnEditar.classList.add('btnEditar');
  btnEditar.style.display = 'none';
  btnEditar.onclick = (e) => { e.stopPropagation(); editarPaso(nombreReceta, li); };

  const btnEliminar = document.createElement('button');
  btnEliminar.textContent = 'Eliminar';
  btnEliminar.classList.add('btnEliminar');
  btnEliminar.style.display = 'none';
  btnEliminar.onclick = (e) => { e.stopPropagation(); confirmarEliminarPaso(nombreReceta, li); };

  const divBotones = document.createElement('div');
  divBotones.style.display = 'inline-block';
  divBotones.style.marginLeft = '10px';
  divBotones.appendChild(btnEditar);
  divBotones.appendChild(btnEliminar);

  // ‚úÖ UX: al tocar un paso, abre sus acciones y cierra las del resto
  li.onclick = () => toggleAccionesPaso(li);

  li.appendChild(divBotones);
  listaPasos.appendChild(li);

  // Renumerar, cerrar acciones (para que no queden botones abiertos ‚Äúraros‚Äù) y limpiar textarea
  renumerarPasos();
  cerrarAccionesPasos();
  textarea.value = '';
}

function renumerarPasos() {
    const lista = document.getElementById('listaPasosGuardados');
    const items = Array.from(lista.querySelectorAll('li'));
    
    items.forEach((li, i) => {
        const strong = li.querySelector('strong');
        if (strong) strong.textContent = `Paso ${i + 1}:`;
    });
}

function guardarPasosDesdeUI(nombreReceta) {
    const listaPasos = document.getElementById('listaPasosGuardados');
    
    // Tomamos la verdad directamente de la UI
    const pasosTexto = Array.from(
            listaPasos.querySelectorAll('li .textoPaso')
        )
        .map(span => span.textContent.trim())
        .filter(Boolean)
        .join('\n');
    
    let recetasGuardadas = Store.loadPasoAPaso();
    let receta = recetasGuardadas.find(r => r.nombre === nombreReceta);
    
    if (receta) {
        receta.pasos = pasosTexto;
    } else {
        recetasGuardadas.push({ nombre: nombreReceta, pasos: pasosTexto });
    }
    
    Store.savePasoAPaso(recetasGuardadas);
    pasoAPaso = recetasGuardadas;
}

function abrirModalEditarPaso(nombreReceta, li) {
    _pasoEditando = { nombreReceta, li };
    
    const span = li.querySelector('.textoPaso');
    document.getElementById('inputEditarPaso').value = (span?.textContent || '').trim();
    
    document.getElementById('modalEditarPaso').style.display = 'flex';
}

function cerrarModalEditarPaso() {
    document.getElementById('modalEditarPaso').style.display = 'none';
    _pasoEditando = { nombreReceta: null, li: null };
}

function abrirModalEliminarPaso(nombreReceta, li) {
    _pasoEliminando = { nombreReceta, li };
    document.getElementById('modalConfirmarEliminarPaso').style.display = 'flex';
}

function cerrarModalEliminarPaso() {
    document.getElementById('modalConfirmarEliminarPaso').style.display = 'none';
    _pasoEliminando = { nombreReceta: null, li: null };
}

function cerrarAccionesPasos(exceptLi = null) {
    const lista = document.getElementById('listaPasosGuardados');
    if (!lista) return;
    
    lista.querySelectorAll('li').forEach(li => {
        if (exceptLi && li === exceptLi) return;
        
        li.classList.remove('paso-seleccionado');
        
        const btnEditar = li.querySelector('.btnEditar');
        const btnEliminar = li.querySelector('.btnEliminar');
        
        if (btnEditar) btnEditar.style.display = 'none';
        if (btnEliminar) btnEliminar.style.display = 'none';
    });
}

function toggleAccionesPaso(li) {
    const btnEditar = li.querySelector('.btnEditar');
    const btnEliminar = li.querySelector('.btnEliminar');
    
    // ¬øEst√° abierto ahora mismo?
    const abierto = btnEditar && btnEditar.style.display === 'inline-block';
    
    // Cierra todos antes de decidir
    cerrarAccionesPasos();
    
    if (!abierto) {
        li.classList.add('paso-seleccionado');
        if (btnEditar) btnEditar.style.display = 'inline-block';
        if (btnEliminar) btnEliminar.style.display = 'inline-block';
    } else {
        li.classList.remove('paso-seleccionado');
        if (btnEditar) btnEditar.style.display = 'none';
        if (btnEliminar) btnEliminar.style.display = 'none';
    }
}


// Mostrar el modal de confirmaci√≥n de vaciar carrito
function mostrarModalVaciarCarrito() {
    const modal = document.getElementById('modalVaciarCarrito');
    modal.style.display = 'flex';
}

// Cerrar el modal de confirmaci√≥n
function cerrarModalVaciarCarrito() {
    const modal = document.getElementById('modalVaciarCarrito');
    modal.style.display = 'none';
}

// Funci√≥n para vaciar el carrito
function vaciarCarrito() {
    const carritoVacio = [];
    
    // ‚úÖ Guardar + refrescar en un solo punto
    saveCarritoAndRefresh(carritoVacio);
    
    // Mostrar el modal de √©xito de vaciado
    mostrarModalCarritoVaciado();
    
    // Cerrar el modal de confirmaci√≥n
    cerrarModalVaciarCarrito();
}


function irAlCarrito() {
    mostrarCarrito(); // Primero actualiza los datos
    mostrarPantalla('pantallaCarrito'); // Luego cambia de pantalla
}

function mostrarModalExitoSeleccionados() {
    const modal = document.getElementById("modalExitoSeleccionados");
    if (!modal) return;
    modal.style.display = "flex";
    setTimeout(() => {
        modal.style.display = "none";
    }, 1000);
}

// Funci√≥n para mostrar el modal de √©xito y ocultarlo despu√©s de 1 segundo
function mostrarModalCarritoVaciado() {
    const modal = document.getElementById('modalCarritoVaciado');
    modal.style.display = 'flex';

    // Cerrar el modal autom√°ticamente despu√©s de 1 segundo
    setTimeout(() => {
        modal.style.display = 'none';
    }, 1000);
}

// Funci√≥n para cerrar el modal de √©xito
function cerrarModalCarritoVaciado() {
    const modal = document.getElementById('modalCarritoVaciado');
    modal.style.display = 'none';
}

// Funci√≥n para cargar las recetas en la pantalla "Paso a Paso"
function cargarRecetasPasoAPaso() {
    const listaPasoAPaso = document.getElementById('listaPasoAPaso');
    listaPasoAPaso.innerHTML = '';
    
    // Fuente √∫nica de verdad
    pasoAPaso = Store.loadPasoAPaso();
    
    if (pasoAPaso.length > 0) {
        pasoAPaso.forEach((receta) => {
            const li = document.createElement('li');
            li.textContent = receta.nombre;
            li.onclick = () => abrirPopupPasos(receta.nombre);
            listaPasoAPaso.appendChild(li);
        });
    } else {
        const li = document.createElement('li');
        li.textContent = 'No hay recetas guardadas.';
        listaPasoAPaso.appendChild(li);
    }

}

function actualizarPantallaPasoAPaso() {
    cargarRecetasPasoAPaso();
}

function verPasosReceta() {
    const nombreReceta = document.getElementById('popup').dataset.nombre;
    
    const pasosGuardados = Store.loadPasoAPaso() || [];
    const receta = pasosGuardados.find(r => r.nombre === nombreReceta);
    
    // ‚úÖ Normalizar "pasos" para evitar receta.pasos.trim() cuando no es string
    let pasos = receta?.pasos;
    
    if (Array.isArray(pasos)) pasos = pasos.join('\n');
    if (typeof pasos !== "string") pasos = "";
    
    if (pasos.trim() !== "") {
        // Si hay pasos, abrir el popup de pasos
        abrirPopupPasos(nombreReceta);
    } else {
      const m = document.getElementById('modalSinPasos');
      if (m) {
        m.style.display = 'flex';
        setTimeout(() => { m.style.display = 'none'; }, 1000);
      } else {
        // Fallback por si el modal no existe (as√≠ nunca rompe la app)
        alert("Esta receta no tiene pasos todav√≠a.");
      }
    }
}


function cerrarModalSinPasos() {
    const m = document.getElementById('modalSinPasos');
    if (m) m.style.display = 'none';
}

function anadirAlCarritoDesdePopup() {
    const popup = document.getElementById('popup');
    const nombreReceta = popup?.dataset?.nombre;
    
    if (!nombreReceta) return;
    
    const receta = (recetas || []).find(r => r.nombre === nombreReceta);
    if (!receta || !Array.isArray(receta.ingredientes)) return;
    
    // Ingredientes seleccionados (del popup)
    const ingredientesSeleccionados = [];
    const checkboxes = popup.querySelectorAll('input[type="checkbox"]:checked');
    
    checkboxes.forEach(checkbox => {
        const index = Number(String(checkbox.id).replace('ingrediente-', ''));
        const ing = receta.ingredientes[index];
        if (!ing) return;
        
        // cantidad puede venir vac√≠a / undefined -> la tratamos como null
        const raw = ing.cantidad;
        const cantidad =
            raw === null || typeof raw === "undefined" || (typeof raw === "string" && raw.trim() === "") ?
            null :
            Number(raw);
        
        ingredientesSeleccionados.push({
            nombre: ing.ingrediente,
            cantidad: Number.isFinite(cantidad) ? cantidad : null
            // id: se asigna al hacer push si hace falta
        });
    });
    
    // Helpers locales (para que funcione aunque no los tengas globales)
    function keyNombre(nombre) {
        return (nombre || "")
            .trim()
            .toLowerCase()
            .replace(/\s+/g, " ");
    }
    
    function toNumberOrNull(v) {
        if (v === null || typeof v === "undefined") return null;
        if (typeof v === "string" && v.trim() === "") return null;
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
    }
    
    function sumarCantidades(a, b) {
        const na = toNumberOrNull(a);
        const nb = toNumberOrNull(b);
        
        if (na === null && nb === null) return null;
        if (na === null) return nb;
        if (nb === null) return na;
        return na + nb;
    }
    
    function generarIdFallback() {
        // Por si no existe generarIdCarrito()
        return "c_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 10);
    }
    
    // Cargar carrito
    let carrito = Store.loadCarrito() || [];
    
    // Asegurar IDs existentes si ya tienes la funci√≥n creada en el Paso 1
    if (typeof asegurarIdsCarrito === "function") {
        const res = asegurarIdsCarrito(carrito);
        if (Array.isArray(res)) carrito = res;
    } else {
        // fallback: asegurar id m√≠nimo
        carrito.forEach(item => {
            if (!item || item.id) return;
            item.id = (typeof generarIdCarrito === "function") ? generarIdCarrito() : generarIdFallback();
        });
    }
    
    // Merge por nombre normalizado
    ingredientesSeleccionados.forEach(nuevo => {
        const k = keyNombre(nuevo?.nombre);
        if (!k) return;
        
        const existente = carrito.find(item => keyNombre(item?.nombre) === k);
        
        if (existente) {
            existente.cantidad = sumarCantidades(existente.cantidad, nuevo.cantidad);
        } else {
            // ID al push (tu ‚Äúpaso 2 redondo‚Äù)
            if (!nuevo.id) {
                nuevo.id = (typeof generarIdCarrito === "function") ? generarIdCarrito() : generarIdFallback();
            }
            carrito.push(nuevo);
        }
    });
    
    // Asegurar IDs justo antes de guardar (tu requisito)
    if (typeof asegurarIdsCarrito === "function") {
        const res2 = asegurarIdsCarrito(carrito);
        if (Array.isArray(res2)) carrito = res2;
    }
    
    // ‚úÖ Guardar + refrescar (UN solo punto)
    saveCarritoAndRefresh(carrito);
    
    // Modal √©xito (mantengo exactamente tu comportamiento)
    const modalExito = document.getElementById('modalExito');
    if (modalExito) {
        modalExito.style.display = 'flex';
        setTimeout(() => {
            modalExito.style.display = 'none';
        }, 1000);
    }
}


function toggleMenuConfiguracion() {
    const menu = document.getElementById('menuConfiguracion');
    menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
}

function abrirMenuTemas() {
    document.getElementById('menuTemas').style.display = 'flex';
    document.getElementById('menuConfiguracion').style.display = 'none'; // Cerrar el men√∫ al abrir el modal
}

function cerrarMenuTemas() {
    document.getElementById('menuTemas').style.display = 'none';
}


function cambiarTema(tema) {
    // Eliminar cualquier otro tema antes de aplicar el nuevo
    document.body.classList.remove('tema-claro', 'tema-oscuro', 'tema-original');
    
    // Aplicar el nuevo tema
    document.body.classList.add(`tema-${tema}`);
    
    
    Store.saveTema(tema);
    
    // Asegurar que los t√≠tulos sean visibles en modo claro
    const titulos = document.querySelectorAll('h1');
    titulos.forEach(titulo => {
        titulo.style.color = (tema === 'claro') ? 'black' : 'white';
    });
    
    // Cerrar el men√∫ de selecci√≥n
    cerrarMenuTemas();
}

function aplicarTema(tema) {
    const body = document.body;
    
    // Eliminar clases previas de tema
    body.classList.remove("tema-claro", "tema-oscuro", "tema-original");
    
    switch (tema) {
        case "claro":
            body.classList.add("tema-claro");
            break;
        case "oscuro":
            body.classList.add("tema-oscuro");
            break;
        case "original":
        default:
            body.classList.add("tema-original");
            break;
    }
    
    
    Store.saveTema(tema);
}

document.addEventListener("DOMContentLoaded", () => {
    const temaGuardado = Store.loadTema() || "original";
    aplicarTema(temaGuardado);
});


function mostrarModalConfirmacionMenu() {
  const modal = document.getElementById("modalConfirmacionMenu");
  modal.style.display = "flex";

  setTimeout(() => {
    modal.style.display = "none";
  }, 1000); // 1 segundo
}

function mostrarExitoPasos() {
    const modal = document.getElementById('modalExitoPasos');
    modal.style.display = 'flex';
    setTimeout(() => modal.style.display = 'none', 900);
}

// --- Botones modal editar ---
document.getElementById('btnCancelarPaso').onclick = cerrarModalEditarPaso;

document.getElementById('btnGuardarPaso').onclick = () => {
    const { nombreReceta, li } = _pasoEditando;
    if (!nombreReceta || !li) return cerrarModalEditarPaso();
    
    const t = document.getElementById('inputEditarPaso').value.trim();
    if (!t) return; // no guardamos vac√≠o
    
    const span = li.querySelector('.textoPaso');
    if (span) span.textContent = t;
    
    renumerarPasos();
    guardarPasosDesdeUI(nombreReceta);
    
    cerrarModalEditarPaso();
};

// --- Botones modal eliminar ---
document.getElementById('btnNoEliminarPaso').onclick = cerrarModalEliminarPaso;

document.getElementById('btnSiEliminarPaso').onclick = () => {
    const { nombreReceta, li } = _pasoEliminando;
    if (!nombreReceta || !li) return cerrarModalEliminarPaso();
    
    eliminarPaso(nombreReceta, li);
    cerrarModalEliminarPaso();
};

function mostrarModalArchivadoExitoso() {
    const modal = document.getElementById("modalArchivadoExitoso");
    if (!modal) return;
    modal.style.display = "flex";
    setTimeout(() => modal.style.display = "none", 1000);
}

function mostrarModalMenuEliminadoExito() {
    const modal = document.getElementById("modalMenuEliminadoExito");
    if (!modal) return;
    modal.style.display = "flex";
    setTimeout(() => modal.style.display = "none", 1000);
}

function abrirModalConfirmarArchivarMenu() {
    const menuActual = Store.loadMenuSemana() || {};
    
    // Si no hay contenido real, no tiene sentido ni confirmar
    const tieneContenido = diasSemana.some(dia => {
        const comida = (menuActual?.[dia]?.comida || "").trim();
        const cena = (menuActual?.[dia]?.cena || "").trim();
        return comida || cena;
    });
    
    if (!tieneContenido) {
        alert("No hay men√∫ semanal para archivar.");
        return;
    }
    
    document.getElementById("modalConfirmacionArchivarMenu").style.display = "flex";
}

document.getElementById("btnCancelarArchivarMenu").onclick = () => {
    document.getElementById("modalConfirmacionArchivarMenu").style.display = "none";
};

document.getElementById("btnConfirmarArchivarMenu").onclick = () => {
    document.getElementById("modalConfirmacionArchivarMenu").style.display = "none";
    archivarMenuActual(); // ahora s√≠, archiva
};

function renderMenuSemanalActual() {
    const menu = Store.loadMenuSemana() || {};
    mostrarMenuSemanal(menu);
}


// ===== DEBUG: capturar errores en pantalla (iPhone friendly) =====
(function() {
    function showError(msg) {
        console.error(msg);
        
        let box = document.getElementById("debugErrorBox");
        if (!box) {
            box = document.createElement("div");
            box.id = "debugErrorBox";
            box.style.position = "fixed";
            box.style.left = "10px";
            box.style.right = "10px";
            box.style.bottom = "10px";
            box.style.zIndex = "999999";
            box.style.background = "rgba(0,0,0,0.85)";
            box.style.color = "white";
            box.style.padding = "10px 12px";
            box.style.borderRadius = "10px";
            box.style.fontSize = "12px";
            box.style.whiteSpace = "pre-wrap";
            box.style.maxHeight = "40vh";
            box.style.overflow = "auto";
            box.style.display = "none";
            
            const btn = document.createElement("button");
            btn.textContent = "Cerrar";
            btn.style.marginTop = "10px";
            btn.style.padding = "6px 10px";
            btn.style.fontSize = "12px";
            btn.onclick = () => (box.style.display = "none");
            box.appendChild(document.createElement("div"));
            box.appendChild(btn);
            
            document.body.appendChild(box);
        }
        
        box.firstChild.textContent = String(msg);
        box.style.display = "block";
    }
    
    window.addEventListener("error", (e) => {
        const msg = `ERROR: ${e.message}\n${e.filename || ""}:${e.lineno || ""}:${e.colno || ""}`;
        showError(msg);
    });
    
    window.addEventListener("unhandledrejection", (e) => {
        const reason = e.reason && (e.reason.stack || e.reason.message || e.reason);
        showError(`PROMISE REJECTION:\n${reason}`);
    });
})();

// ===== PWA: registro del Service Worker (con update limpio + aviso) =====
if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
        try {
            const reg = await navigator.serviceWorker.register("./sw.js?v=2026-01-06-08");
            
            // Forzar comprobaci√≥n de nueva versi√≥n al cargar
            reg.update().catch(() => {});
            
            // ===== Aviso visual de actualizaci√≥n disponible =====
            function showUpdateBanner(registration) {
                const banner = document.getElementById("updateBanner");
                const btn = document.getElementById("btnActualizarApp");
                if (!banner || !btn) return;
                
                banner.classList.add("is-visible");
                
                btn.onclick = () => {
                    // Feedback inmediato (sin ocultar a√∫n)
                    btn.disabled = true;
                    btn.textContent = "Actualizando‚Ä¶";
                    
                    // Pedimos al SW en espera que se active ya
                    if (registration.waiting) {
                        registration.waiting.postMessage({ type: "SKIP_WAITING" });
                    }
                };
            }
            
            // Si ya hay un SW nuevo esperando al cargar
            if (reg.waiting) {
                showUpdateBanner(reg);
            }
            
            // Detectar instalaci√≥n de un nuevo SW en esta sesi√≥n
            reg.addEventListener("updatefound", () => {
                const newWorker = reg.installing;
                if (!newWorker) return;
                
                newWorker.addEventListener("statechange", () => {
                    if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
                        showUpdateBanner(reg);
                    }
                });
            });
            
            // ===== Recarga limpia UNA sola vez cuando el SW toma control =====
            let reloaded = false;
            navigator.serviceWorker.addEventListener("controllerchange", () => {
                if (reloaded) return;
                reloaded = true;
                
                // Ocultar banner (si existe) justo antes de recargar
                const banner = document.getElementById("updateBanner");
                if (banner) banner.classList.remove("is-visible");
                
                window.location.reload();
            });
            
            console.log("Service Worker registrado con control de versi√≥n y update limpio");
        } catch (e) {
            console.warn("Error registrando Service Worker:", e);
        }
    });
}


function saveCarritoAndRefresh(carritoNuevo) {
    Store.saveCarrito(carritoNuevo);
    carrito = carritoNuevo; // si usas variable global
    mostrarCarrito();
}

function generarIdDespensa() {
    return "dsp_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
}

function asegurarIdsDespensa(arr) {
    if (!Array.isArray(arr)) return arr;
    
    let cambiado = false;
    
    for (const item of arr) {
        if (!item || typeof item !== "object") continue;
        if (!item.id) {
            item.id = generarIdDespensa();
            cambiado = true;
        }
    }
    
    // No guardamos aqu√≠: lo har√° getDespensaSeguro() si detecta cambios
    arr.__idsMigrados = cambiado; // opcional (puedes quitarlo si quieres)
    return arr;
}

function normalizarCantidadDespensa(v) {
    // null/undefined/"" => null
    if (v === null || typeof v === "undefined") return null;
    
    if (typeof v === "string") {
        const t = v.trim();
        if (t === "") return null;
        // soporta "8,5"
        v = t.replace(",", ".");
    }
    
    const n = Number(v);
    return Number.isFinite(n) ? n : null; // OJO: 0 se mantiene como 0 (no lo convertimos a null)
}

function getDespensaSeguro() {
    const raw = Store.loadDespensa();
    const arr = Array.isArray(raw) ? raw : [];
    
    let cambiado = false;
    
    const normalizado = arr.map((it) => {
        // Si el item es basura, lo ‚Äúlimpiamos‚Äù a objeto m√≠nimo
        const obj = (it && typeof it === "object") ? it : {};
        
        const beforeId = obj.id;
        const beforeNombre = obj.nombre;
        const beforeCant = obj.cantidad;
        const beforeCad = obj.caducidad;
        
        const n = {
            id: (obj.id ?? "").toString().trim(),
            nombre: (obj.nombre ?? "").toString(),
            cantidad: normalizarCantidadDespensa(obj.cantidad),
            caducidad: (obj.caducidad === null || typeof obj.caducidad === "undefined" || String(obj.caducidad).trim() === "") ?
                null :
                String(obj.caducidad).trim()
        };
        
        // Si falta id, lo ponemos despu√©s con asegurarIdsDespensa()
        if (beforeId !== n.id) cambiado = true;
        if ((beforeNombre ?? "") !== n.nombre) cambiado = true;
        
        const a = normalizarCantidadDespensa(beforeCant);
        if (a !== n.cantidad) cambiado = true;
        
        const cadBefore = (beforeCad === null || typeof beforeCad === "undefined" || String(beforeCad).trim() === "") ?
            null :
            String(beforeCad).trim();
        if (cadBefore !== n.caducidad) cambiado = true;
        
        return n;
    });
    
    asegurarIdsDespensa(normalizado);
    
    // Guardar SOLO si cambi√≥ algo (normalizaci√≥n o IDs)
    if (cambiado || normalizado.__idsMigrados) {
        Store.saveDespensa(normalizado);
        despensa = normalizado; // mantiene tu global sincronizada
    }
    
    return normalizado;
}

function abrirVerDespensa() {
    mostrarPantalla("pantallaDespensaVer");
    mostrarDespensa();
}


function saveDespensaAndRefresh(despensaNueva) {
    Store.saveDespensa(despensaNueva);
    despensa = despensaNueva; // si usas variable global
    mostrarDespensa();
}

function cerrarAccionesDespensa() {
    document.querySelectorAll('#listaDespensa .acciones-despensa')
        .forEach(div => div.style.display = 'none');
}


function mostrarDespensa() {
    const ul = document.getElementById("listaDespensa");
    if (!ul) return;
    
    const data = getDespensaSeguro();
    ul.innerHTML = "";
    
    if (data.length === 0) {
        const li = document.createElement("li");
        li.textContent = "La despensa est√° vac√≠a";
        li.style.color = "white";
        li.style.textAlign = "center";
        li.style.marginTop = "20px";
        li.style.cursor = "default";
        ul.appendChild(li);
        
        // paginaci√≥n: ocultar/actualizar
        actualizarPaginacionDespensa(0);
        return;
    }
    
    // Orden por nombre (sin mutar)
    const ordenado = data.slice().sort((a, b) =>
        (a.nombre || "").localeCompare(b.nombre || "")
    );
    
    // Paginaci√≥n
    const totalPaginas = Math.ceil(ordenado.length / elementosPorPaginaDespensa);
    if (paginaDespensaActual > totalPaginas) paginaDespensaActual = totalPaginas;
    if (paginaDespensaActual < 1) paginaDespensaActual = 1;
    
    const inicio = (paginaDespensaActual - 1) * elementosPorPaginaDespensa;
    const fin = inicio + elementosPorPaginaDespensa;
    const paginaItems = ordenado.slice(inicio, fin);
    
    paginaItems.forEach((item) => {
        const li = document.createElement("li");
        // ‚úÖ si ya estaba seleccionado (paginaci√≥n / repintado), mantener el highlight
        if (item.id && despensaSeleccionados.has(item.id)) {
            li.classList.add("seleccionado");
        }
        
        const nombre = (item.nombre || "").toUpperCase();
        const cantidad =
            item.cantidad === null ||
            item.cantidad === "" ||
            typeof item.cantidad === "undefined" ?
            "" :
            String(item.cantidad);
        
        const cad = (item.caducidad || "").trim();
        
        let linea = nombre;
        if (cantidad) linea += ` | ${cantidad}`;
        if (cad) linea += ` | Cad: ${cad}`;
        
        const texto = document.createElement("div");
        texto.textContent = linea;
        li.appendChild(texto);
        
        const acciones = document.createElement("div");
        acciones.className = "acciones-despensa";
        if (modoSeleccionMultipleDespensa) acciones.style.display = "none";
        
        const btnEditar = document.createElement("button");
        btnEditar.textContent = "Editar";
        btnEditar.type = "button";
        btnEditar.onclick = (e) => {
            e.stopPropagation();
            abrirModalEdicionDespensaPorId(item.id);
        };
        
        const btnEliminar = document.createElement("button");
        btnEliminar.textContent = "Eliminar";
        btnEliminar.type = "button";
        btnEliminar.onclick = (e) => {
            e.stopPropagation();
            abrirModalConfirmacionDespensaPorId(item.id);
        };
        
        acciones.appendChild(btnEditar);
        acciones.appendChild(btnEliminar);
        li.appendChild(acciones);
        
        li.addEventListener("click", () => {
            if (modoSeleccionMultipleDespensa) {
                toggleSeleccionDespensa(item.id, li);
                return;
            }
    
            const estaVisible = acciones.style.display === "flex";
    
            document
                .querySelectorAll("#listaDespensa .acciones-despensa")
                .forEach((div) => (div.style.display = "none"));
    
            if (!estaVisible) acciones.style.display = "flex";
        });
        
        li.addEventListener("touchstart", function() {
            tiempoPresionadoDespensa = setTimeout(() => {
                // ‚úÖ al entrar en modo selecci√≥n, cerrar cualquier acciones abierta
                cerrarAccionesDespensa();
        
                 modoSeleccionMultipleDespensa = true;
                 toggleSeleccionDespensa(item.id, li);
            }, 350);
        });

        li.addEventListener("touchend", function() {
            clearTimeout(tiempoPresionadoDespensa);
        });
        
        ul.appendChild(li);
    });
    
    // Pintar/actualizar controles paginaci√≥n
    actualizarPaginacionDespensa(ordenado.length);
}



function keyNombre(nombre) {
    return (nombre || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, " ");
}


function guardarProductoDespensa() {
    const nombre = document.getElementById("despensaNombre")?.value?.trim() || "";
    const cantidadRaw = document.getElementById("despensaCantidad")?.value?.trim() || "";
    const caducidad = document.getElementById("despensaCaducidad")?.value?.trim() || "";
    
    if (!nombre) {
        alert("El nombre del producto es obligatorio.");
        return;
    }
    
    
 
    
    // Helpers (locales para no depender de nada externo)
    function toNumberOrNull(v) {
        if (v === null || typeof v === "undefined") return null;
        if (typeof v === "string") {
            const t = v.trim();
            if (t === "") return null;
            // Soporta "8,5"
            v = t.replace(",", ".");
        }
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
    }
    
    function sumarCantidades(a, b) {
        const na = toNumberOrNull(a);
        const nb = toNumberOrNull(b);
        
        // Si no llega cantidad nueva, no tocamos la existente
        if (nb === null) return a ?? null;
        
        // Si la existente no es n√∫mero, pero la nueva s√≠, nos quedamos con la nueva
        if (na === null) return nb;
        
        return na + nb;
    }
    
    // Cargamos despensa ‚Äúsegura‚Äù
    const data = getDespensaSeguro();
    
    // Merge por nombre normalizado (usa tu helper keyNombre() existente)
    const k = keyNombre(nombre);
    const existente = data.find(it => it && keyNombre(it.nombre || "") === k);
    
    if (existente) {
        // ‚úÖ Cantidad: SUMA (si llega cantidad v√°lida). Si llega vac√≠o, NO machaca.
        existente.cantidad = sumarCantidades(existente.cantidad, cantidadRaw);
        
        // Caducidad: si llega, actualiza; si llega vac√≠o, no machaca
        if (caducidad !== "") existente.caducidad = caducidad;
        
    } else {
        // Nuevo item
        const nCant = toNumberOrNull(cantidadRaw);
        
        data.push({
            id: generarIdDespensa(),
            nombre,
            cantidad: nCant === null ? null : nCant,
            caducidad: caducidad === "" ? null : caducidad
        });
    }
    
    // Guardar + refrescar con tu helper (mantiene variable global y repinta)
    saveDespensaAndRefresh(data);
    
    // Limpiar campos
    document.getElementById("despensaNombre").value = "";
    document.getElementById("despensaCantidad").value = "";
    document.getElementById("despensaCaducidad").value = "";
    
    // Modal √©xito (si existe)
    const modal = document.getElementById("modalDespensaGuardado");
    if (modal) {
        modal.style.display = "flex";
        setTimeout(() => (modal.style.display = "none"), 900);
    }
    
    // Llevar a ‚ÄúVer Despensa‚Äù
    mostrarPantalla("pantallaDespensaVer");
}


function abrirModalEdicionDespensaPorId(id) {
    const actual = getDespensaSeguro();
    const item = actual.find(p => p && p.id === id);
    if (!item) return;
    
    document.getElementById("editarNombreDespensa").value = item.nombre || "";
    document.getElementById("editarCantidadDespensa").value = item.cantidad ?? "";
    document.getElementById("editarCaducidadDespensa").value = item.caducidad ?? "";
    
    const modal = document.getElementById("modalEditarDespensa");
    modal.dataset.id = id;
    modal.style.display = "flex";
}

function cerrarModalEditarDespensa() {
    const modal = document.getElementById("modalEditarDespensa");
    if (!modal) return;
    modal.style.display = "none";
    delete modal.dataset.id;
}

function guardarEdicionDespensa() {
    const modal = document.getElementById("modalEditarDespensa");
    const id = modal?.dataset?.id;
    if (!id) return;
    
    const nuevoNombre = (document.getElementById("editarNombreDespensa").value || "").trim();
    const cantidadRaw = (document.getElementById("editarCantidadDespensa").value || "").trim();
    const cad = (document.getElementById("editarCaducidadDespensa").value || "").trim();
    
    if (!nuevoNombre) {
        alert("El nombre no puede estar vac√≠o.");
        return;
    }
    
    const actual = getDespensaSeguro();
    const item = actual.find(p => p && p.id === id);
    if (!item) return;
    
    item.nombre = nuevoNombre;
    const n = cantidadRaw === "" ? null : Number(cantidadRaw.replace(",", "."));
    item.cantidad = (n === null || Number.isFinite(n)) ? n : null;
    item.caducidad = cad === "" ? null : cad;
    
    saveDespensaAndRefresh(actual);
    cerrarModalEditarDespensa();
}

function abrirModalConfirmacionDespensaPorId(id) {
    const modal = document.getElementById("modalConfirmacionDespensa");
    if (!modal) return;
    modal.dataset.id = id;
    modal.style.display = "flex";
}

function cerrarModalConfirmacionDespensa() {
    const modal = document.getElementById("modalConfirmacionDespensa");
    if (!modal) return;
    modal.style.display = "none";
    delete modal.dataset.id;
}

function confirmarEliminacionDespensa() {
    const modal = document.getElementById("modalConfirmacionDespensa");
    const id = modal?.dataset?.id;
    if (!id) return;
    
    const actual = getDespensaSeguro();
    const nuevo = actual.filter(p => p && p.id !== id);
    
    saveDespensaAndRefresh(nuevo);
    cerrarModalConfirmacionDespensa();
}

function confirmarEliminacionSeleccionadosDespensa() {
    const data = getDespensaSeguro();
    
    const nuevo = data.filter(it => it && it.id && !despensaSeleccionados.has(it.id));
    
    saveDespensaAndRefresh(nuevo);
    
    cerrarModalConfirmacionSeleccionadosDespensa();
    salirSeleccionMultipleDespensa();
    
    // Si est√°s en Ver Despensa, repinta (adem√°s ya lo hace saveDespensaAndRefresh, pero no molesta)
    mostrarDespensa();
}



// ===== UX: cerrar acciones de Despensa al tocar fuera (simple) =====
(function wireCerrarAccionesDespensaAlTocarFuera() {
    function closeAll() {
        document.querySelectorAll('#listaDespensa .acciones-despensa')
            .forEach(div => div.style.display = 'none');
    }
    
    document.addEventListener('pointerdown', (e) => {
        const raw = e.target;
        const el = (raw && raw.nodeType === 3) ? raw.parentElement : raw;
        if (!el) return;
        
        const li = el.closest('#listaDespensa li');
        if (!li) return closeAll(); // click fuera de la lista
        if (el.closest('.acciones-despensa')) return; // click dentro de acciones => no cierres
        
        // si tocaste un li, cierra las acciones abiertas en otros
        document.querySelectorAll('#listaDespensa .acciones-despensa')
            .forEach(div => { if (!li.contains(div)) div.style.display = 'none'; });
    }, true);
})();

(function wireDespensaSeleccionMultiple() {
    const btnEliminar = document.getElementById("btnEliminarSeleccionadosDespensa");
    const btnOK = document.getElementById("btnConfirmarEliminarSeleccionadosDespensa");
    const btnCancel = document.getElementById("btnCancelarEliminarSeleccionadosDespensa");
    
    if (btnEliminar) btnEliminar.onclick = abrirModalConfirmacionSeleccionadosDespensa;
    if (btnCancel) btnCancel.onclick = cerrarModalConfirmacionSeleccionadosDespensa;
    if (btnOK) btnOK.onclick = confirmarEliminacionSeleccionadosDespensa;
})();


// ===== Despensa: salir del modo selecci√≥n tocando fuera (sin romper botones/modales) =====
(function wireSalirSeleccionDespensaAlTocarFuera() {
    const pantalla = document.getElementById("pantallaDespensaVer");
    const ul = document.getElementById("listaDespensa");
    if (!pantalla || !ul) return;
    
    pantalla.addEventListener("click", (e) => {
        if (!modoSeleccionMultipleDespensa) return;
        
        const t = e.target;
        
        // ‚úÖ Si tocas dentro de la lista, NO sales
        if (ul.contains(t)) return;
        
        // ‚úÖ Si tocas el bot√≥n de eliminar seleccionados, NO salgas (es parte del flujo)
        if (t.closest("#btnEliminarSeleccionadosDespensa")) return;
        
        // ‚úÖ Si tocas paginaci√≥n o volver, tampoco salgas (evita ‚Äúreseteos‚Äù raros)
        if (t.closest("#paginacionDespensa")) return;
        if (t.closest(".btn-volver")) return;
        
        // ‚úÖ Si hay un modal abierto y tocas dentro, NO salgas
        if (t.closest(".modal") || t.closest(".modal-content") || t.closest(".modal-contenido")) return;
        
        // Salimos del modo selecci√≥n
        salirSeleccionMultipleDespensa();
        mostrarDespensa();
    });
})();

    </script>
    
    <div id="updateBanner">
        <span>Hay una nueva versi√≥n disponible.</span>
        <button id="btnActualizarApp" type="button">Actualizar</button>
    </div>
   
    
</body>
</html>
